# -*- mode: tcl -*-
#------------------------------------------------------------------------------
# this example shows how to configure a job to
#
# - generate conversion electron events
# - run simulation+reconstruction chain
# - run particle ID
#
# local submission:
#
#  mu2e -c Analyses/test/genReco.fcl -n 1000 >| results/2014-12-19-Analyses_test_genReco.log 2>&1 &
#------------------------------------------------------------------------------

#include "minimalMessageService.fcl"
#include "standardProducers.fcl"
#include "standardServices.fcl"

#include "Analyses/fcl/prolog.fcl"

#------------------------------------------------------------------------------
# define module sequences 
#------------------------------------------------------------------------------
BEGIN_PROLOG
  generatorSeq  : [ generate, g4run, protonTimeMap, muonTimeMap ]

  hitMakerSeq   : [ MakeCaloReadoutHits, MakeCaloCrystalHits, makeSD, makeSH ]

# MC generator and hit makers
  genHitsSeq    : [ @sequence::generatorSeq, @sequence::hitMakerSeq ]

# calorimeter cluster reconstruction
  calRecoSeq    : [ MakeCaloProtoCluster, MakeCaloCluster ]

# MC generator and hit makers
  genHitsSeq    : [ @sequence::generatorSeq, @sequence::hitMakerSeq ]

# hit pre-making for TrkPatRec; FSHPreStereo is needed to flag straw hits
  tprMakeHitSeq : [ FSHPreStereo, MakeStereoHits, FlagStrawHits, FlagBkgHits ]

# hit making for CalPatRec
  cprMakeHitSeq : [ CalPatRecFSHP, CalPatRecMakeStrawHitPositions, CalPatRecMakeStereoHits,  
		    CalPatRecFlagStrawHits, CalPatRecFlagBkgHits ]
# 
  trkPatRecSeq  : [ @sequence::tprMakeHitSeq, TrkPatRec, MergePatRec ]
  calPatRecSeq  : [ @sequence::cprMakeHitSeq, CalPatRec, MergePatRec ]
  allPatRecSeq  : [ @sequence::tprMakeHitSeq, TrkPatRec, @sequence::cprMakeHitSeq, CalPatRec, MergePatRec ]

#------------------------------------------------------------------------------
# downstream electron and downstream muon reconstruction - needed for particle ID
#------------------------------------------------------------------------------
  trkPatRecDemDmmSeq  : [ @sequence::tprMakeHitSeq, TrkPatRecDem, TrkPatRecDmm, MergePatRecDem, MergePatRecDmm ]

  calPatRecDemDmmSeq  : [ @sequence::cprMakeHitSeq, CalPatRecDem, CalPatRecDmm, MergePatRecDem, MergePatRecDmm ]

  allPatRecDemDmmSeq  : [ @sequence::tprMakeHitSeq, TrkPatRecDem, TrkPatRecDmm, 
			  @sequence::cprMakeHitSeq, CalPatRecDem, CalPatRecDmm, 
			  MergePatRecDem, MergePatRecDmm ]

# particle identification

  vadimPidSeq         : [ TrkExtrapol, CaloMatching, ParticleID ]
  avikPidSeq          : [ TrkExtrapolDem, TrkExtrapolDmm, CaloMatchingDem, CaloMatchingDmm, AvikPID ]

#   muStops      : @local::mergedMuonStops
END_PROLOG

process_name : GenReco
#------------------------------------------------------------------------------
# define input module
#------------------------------------------------------------------------------
source : {
    module_type : EmptyEvent
}
#------------------------------------------------------------------------------
# define output module
#------------------------------------------------------------------------------
outputs: {
    detectorOutput : {
        module_type : RootOutput
#        SelectEvents: { SelectEvents: [p1] }
        outputCommands:   [ "keep *_*_*_*",
                            "drop mu2e::PhysicalVolumeInfomvstd::pairs_g4run_*_*"
                          ]
        fileName    : "genReco.art"
    }
}
#------------------------------------------------------------------------------
# services  section
#------------------------------------------------------------------------------
services : {

    message               : @local::default_message
    TFileService          : { fileName : "genReco.hist" }
    RandomNumberGenerator : { }

    # Mu2e services
    GeometryService        : { inputFile      : "Mu2eG4/test/geom_01.txt" }
    ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"        }
    GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt"   }
    G4Helper               : { }
    BTrkHelper             : @local::BTrkHelperDefault
    SeedService            : { @table::automaticSeeds
       baseSeed            :  0
       maxUniqueEngines    :  20
    }
}
#------------------------------------------------------------------------------
# specify modules
#------------------------------------------------------------------------------
physics : {
    producers: {
	generate             : { @table::StoppedParticleReactionGun }
	g4run                : @local::g4run
#------------------------------------------------------------------------------
# hit makers
#------------------------------------------------------------------------------
        protonTimeMap        : @local::protonTimeMap
        muonTimeMap          : @local::muonTimeMap
        makeSD               : @local::makeSD
        makeSH               : @local::makeSHfromSD
	MakeCaloReadoutHits  : @local::MakeCaloReadoutHits
	MakeCaloCrystalHits  : @local::MakeCaloCrystalHitsNew
#------------------------------------------------------------------------------
# calorimeter reconstruction
#------------------------------------------------------------------------------
	MakeCaloProtoCluster : @local::MakeCaloProtoCluster
	MakeCaloCluster      : @local::MakeCaloCluster
#------------------------------------------------------------------------------
#  TrkPatRec 
#------------------------------------------------------------------------------
	FSHPreStereo         : @local::FSHPreStereo
	MakeStereoHits       : @local::MakeStereoHits
	FlagStrawHits        : @local::FlagStrawHits
	FlagBkgHits          : @local::FlagBkgHits

	TrkPatRec            : { @table::TrkPatRecDownstreameMinus  }
	TrkPatRecDem         : { @table::TrkPatRecDownstreameMinus  }
	TrkPatRecDmm         : { @table::TrkPatRecDownstreammuMinus }
#------------------------------------------------------------------------------
# CalPatRec 
#------------------------------------------------------------------------------
	MakeStrawHitPositions: @local::MakeStrawHitPositions

	CalPatRecFSHP                  : @local::CalPatRecFSHP
	CalPatRecMakeStrawHitPositions : @local::CalPatRecMakeStrawHitPositions
	CalPatRecMakeStereoHits        : @local::CalPatRecMakeStereoHits
	CalPatRecFlagStrawHits         : @local::CalPatRecFlagStrawHits
	CalPatRecFlagBkgHits           : @local::CalPatRecFlagBkgHits
	CalPatRec                      : { @table::CalPatRec    }
	CalPatRecDem                   : { @table::CalPatRecDem }
	CalPatRecDmm                   : { @table::CalPatRecDmm }

	MergePatRec                    : @local::MergePatRec
	MergePatRecDem                 : @local::MergePatRecDem
	MergePatRecDmm                 : @local::MergePatRecDmm
#------------------------------------------------------------------------------
# needed for analysis
#------------------------------------------------------------------------------
	TrkExtrapol          : { @table::TrackCaloIntersection
	    fitterModuleLabel : MergePatRec 
	}

	TrkExtrapolDem       : { @table::TrackCaloIntersection
	    fitparticle       : 11
	    fitterModuleLabel : MergePatRecDem 
	}
	TrkExtrapolDmm       : { @table::TrackCaloIntersection
	    fitparticle       : 13
	    fitterModuleLabel : MergePatRecDmm 
	}

	CaloMatching         : { @table::TrackCaloMatching 
	    fitterModuleLabel : MergePatRec 
	}

	CaloMatchingDem      : { @table::TrackCaloMatching 
	    fitparticle                  : 11
	    fitdirection                 : 0
	    fitterModuleLabel            : MergePatRecDem
	    trkToCaloExtrapolModuleLabel : TrkExtrapolDem
	}

	CaloMatchingDmm      : { @table::TrackCaloMatching 
	    fitparticle                  : 13
	    fitdirection                 : 0
	    fitterModuleLabel            : MergePatRecDmm 
	    trkToCaloExtrapolModuleLabel : TrkExtrapolDmm
	}

	AvikPID              : { @table::AvikPID           
	    trkPatRecDemModuleLabel : MergePatRecDem 
	    trkPatRecDmmModuleLabel : MergePatRecDmm 
	}

	TrackSummaryMaker:    { @table::TrackSummaryMaker
	    trackInput : "MergePatRecDem:DownstreameMinus"
	}
    }

    filters: {
#------------------------------------------------------------------------------
# Andrej's filter
# Reject events with no hits from signal-like tracks in the detectors.
# The filter does not look at the background hits from mixed events.
#------------------------------------------------------------------------------
	FilterStepPointMomentum: {
            module_type    : FilterStepPointMomentum
            inputs         : [ "g4run:tracker", "g4run:calorimeter", "g4run:calorimeterRO"]
            cutMomentumMin : 10. # MeV/c
        }
    }
#------------------------------------------------------------------------------
# analyzers:
#------------------------------------------------------------------------------
    analyzers: {

#     Read the TrkPatRec output and make diagnostic ntuples.
      RKFDownstreameMinus: {
         module_type          : ReadKalFits
         fitterModuleLabel    : MergePatRecDem
         KalDiag : {
          MCPtrLabel          : "makeSH"
          MCStepsLabel        : "g4run"
          SimParticleLabel    : "g4run"
          SimParticleInstance : ""
          StrawHitMCLabel     : "makeSH"
          TimeOffsets         :  { inputs : [ "protonTimeMap", "muonTimeMap" ] }
        }
      }

    }
#------------------------------------------------------------------------------
# paths:
#------------------------------------------------------------------------------
    e1 : [ RKFDownstreameMinus ]
#    e1 : [  ]

    p1 : [generate, g4run
	  , protonTimeMap, muonTimeMap
	  , makeSD, makeSH
	  , MakeCaloReadoutHits, MakeCaloCrystalHits
	  , MakeCaloProtoCluster, MakeCaloCluster
#
	  , FSHPreStereo, MakeStereoHits, FlagStrawHits, FlagBkgHits, TrkPatRec
#
	  , TrkExtrapol, CaloMatching, ParticleID
	 ]

    gen_allpatrec_reco : [ @sequence::generatorSeq, 
			   @sequence::hitMakerSeq,
			   @sequence::calRecoSeq, 
			   @sequence::allPatRecDemDmmSeq,
			   @sequence::avikPidSeq
			   , TrackSummaryMaker
			  ]

    trigger_paths  : [gen_allpatrec_reco]

# to disable writing out the DST file, replace [detectorOutput] with []
    out : [detectorOutput]
#    out : []
    end_paths      : [e1, out]
}
#------------------------------------------------------------------------------
# redefinitions
#------------------------------------------------------------------------------
# 1. only for interactive submission
#------------------------------------------------------------------------------

# print per event timing for ::event entry points
# services.Timing: { }
# print
services.scheduler.wantSummary: true

# Apply the time offsets at the digitization stage
# physics.producers.makeSD.TimeOffsets               : { inputs : [ "protonTimeMap", "muonTimeMap" ] }
# physics.producers.CaloReadoutHitsMaker.TimeOffsets : { inputs : [ "protonTimeMap", "muonTimeMap" ] }

