#
#  This script runs hit and track reconstruction starting from MCStepPoints.
# for example, the command
#  > mu2e --config KalTests/test/TracksFromStepPoints.fcl --source-list /mu2e/data/tdr/beam/g4s4p7/filelist-g4s4p7-conversion-1e5.txt --nevts 100
# will process 100 events from the TDR sample of pure conversion electrons
#
# David Brown, 19 Feb 2015
#
#include "minimalMessageService.fcl"
#include "standardProducers.fcl"
#include "standardServices.fcl"

process_name : TracksFromStepPoints

source :
{
  module_type : RootInput
  maxEvents: 100
}

services :
{
  messageService : @local::default_message
  TFileService : { fileName : "TracksFromStepPoints.root" }
  RandomNumberGenerator: { }
  user :
  {
    GeometryService        : { inputFile : "Mu2eG4/test/geom_01.txt" }
    ConditionsService : { conditionsfile : "Mu2eG4/test/conditions_01.txt" }
    GlobalConstantsService : { inputFile : "Mu2eG4/test/globalConstants_01.txt" }
    SeedService: @local::automaticSeeds
  }
}

physics :
{
  producers :
  {
    protonTimeMap: { module_type : GenerateProtonTimes }
    muonTimeMap: { module_type : GenerateMuonLife }
    makeSD: @local::makeSD
    makeSH: @local::makeSHfromSD
    FSHPreStereo: @local::FSHPreStereo
    MakeStereoHits: @local::MakeStereoHits
    FlagStrawHits: @local::FlagStrawHits
    FlagBkgHits: @local::FlagBkgHits
# track downstream eminus (ie conversion candidates)
    TPRDownstreameMinus : @local::TrkPatRecDownstreameMinus
# Tracking for some different particle types, enable as necessary
#     TPRDownstreamePlus : @local::TrkPatRecDownstreamePlus
#     TPRUpstreameMinus : @local::TrkPatRecUpstreameMinus
#     TPRUpstreamePlus : @local::TrkPatRecUpstreamePlus
#     TPRDownstreammuMinus : @local::TrkPatRecDownstreammuMinus
#     TPRDownstreammuPlus : @local::TrkPatRecDownstreammuPlus
#     TPRUpstreammuMinus : @local::TrkPatRecUpstreammuMinus
#     TPRUpstreammuPlus : @local::TrkPatRecUpstreammuPlus
  }
   analyzers: {
# count generated events
      genCountLogger: { module_type: GenEventCountReader }
# read Kalman fit DownstreameMinus tracks
      RKFDownstreameMinus: {
         module_type: ReadKalFits
         fitterModuleLabel: TPRDownstreameMinus
	 KalDiag : { 
	  MCPtrLabel : "makeSH"
	  MCStepsLabel : "detectorFilter"
	  SimParticleLabel : "detectorFilter"
	  SimParticleInstance : "s0"
	  StrawHitMCLabel : "makeSH"
	  TimeOffsets :  { inputs : [ "protonTimeMap", "muonTimeMap" ] }

	  # track-level diagnostics.  For detailed (hit-level) diagnostics use diagLevel : 2
	  diagLevel : 1 
	}
      }
   }
# trigger path
  p1 : [protonTimeMap, muonTimeMap, makeSD, makeSH, FSHPreStereo, MakeStereoHits, FlagStrawHits, FlagBkgHits, 
  TPRDownstreameMinus ]
 # TPRDownstreamePlus,TPRUpstreameMinus, TPRUpstreamePlus,
 # TPRDownstreammuMinus, TPRDownstreammuPlus,TPRUpstreammuMinus, TPRUpstreammuPlus]
# end path
  e1 : [RKFDownstreameMinus]
  
  trigger_paths  : [p1]
  end_paths      : [e1]
}

# specify the time offset maps when building straw digis
physics.producers.makeSD.TimeOffsets.inputs : [ "protonTimeMap", "muonTimeMap" ] 

services.user.SeedService.baseSeed         :  773651
services.user.SeedService.maxUniqueEngines :  20


