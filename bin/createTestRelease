#! /bin/bash
#
# Script to create a test release in the current directory and a
# matching directory on /mu2e/data to hold output files.
#
#  $Id: createTestRelease,v 1.6 2012/09/24 19:00:42 gandr Exp $
#  $Author: gandr $
#  $Date: 2012/09/24 19:00:42 $
#
# This script resides a base release and it will connect the test release
# to the base release in which this script resides.  Normally you should
# execute this script before setting up a base release.  If you have already
# setup a base release, then this script must reside in that release.
# ( ie for convenience we let you do things out of order but we protect
#   against cross-stitching things ).
#
# The script takes an optional command line argument: the name of the
# setup file in the base release that you should source when you setup
# the base release.
#

if [ "${MU2E}" = '' ];then
    echo "The environment variable MU2E is not set."
    echo "You must setup the local Mu2e environment before sourcing this script."
    return 1
fi

# The base release will be the release in which we find this createTestRelease script.
export candidate_base_release=`cd "$(dirname ${BASH_SOURCE})" >/dev/null 2>&1 && /bin/pwd | sed 's/\/bin//'`

# If a base release is already setup, then it must match the candidate_base_release.
if [ "${MU2E_BASE_RELEASE}" != '' ];then
    if [ "${MU2E_BASE_RELEASE}"  != "${candidate_base_release}" ]; then
      echo "You already have a Mu2e base release established:  " ${MU2E_BASE_RELEASE}
      echo "You are trying to create test release from a different base release: " ${candidate_base_release}
      echo "This is not permitted."
      echo "Stopping now."
      return 1
    fi
fi

# Make sure that we will not overwrite existing files.
# It is the users responsibility to clean up before pointing his test
# release at a new base release.
stuff_to_clean="SConstruct setup.sh bin lib"
for stuff in ${stuff_to_clean}
do
if [ -e ${stuff} ];then
   echo "The file or directory " $stuff " already exists."
   echo "Please clean up and restart."
   echo "The list to clean up is: " $stuff_to_clean
   echo "Stopping now."
   return 1
fi
done

# The script will also make a directory for output files on one of the
# data disks.  If that directory already exists, issue and error and stop.
outputDirBase=/mu2e/data/users/
outputDir=$outputDirBase`/bin/pwd | sed -e 's|^.*/'$(whoami)'/|'$(whoami)/'|'`

if [ -e  ${outputDir} ]; then
 echo "The matching data directory already exists: " ${outputDir}
 echo "Please mv or rm that directory and restart."
 return 1
fi

# If the optional argument has been specified, get it.
setupname="setup.sh"
if [ $# == 1 ]; then
  setupname=$1
fi
echo "setupname: " $setupname

# All tests passed. Now create the test release.

# Copy some files from the base release.
echo "Creating test release:"
cp ${candidate_base_release}/SConstruct .
mkdir -p bin
mkdir -p lib

# Create the output directory.
echo "Making matching directory for output files:" ${outputDir}
mkdir -p ${outputDir}/out
ln -s ${outputDir}/out

# Create the setup script for the test release.
# Hardcode the path to the base release.
cat >> setup.sh <<EOF
#! /bin/bash
#
# This script was written by createTestRelease
# Normally you should not edit it.
#
#

# Connect to the base release.
source ${candidate_base_release}/${setupname}

export PATH="\`pwd\`/bin/:\${PATH}"
export LD_LIBRARY_PATH="\`pwd\`/lib/:\${LD_LIBRARY_PATH}"

EOF
