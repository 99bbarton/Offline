# -*- mode: tcl -*-
# this file depends on analysis through KalDiag and so needs the following
# This depedency is deprecated and should be removed FIXME!!
#include "TrkDiag/fcl/KalDiag.fcl"
#------------------------------------------------------------------------------
# this file is included by fcl/standardProducers.fcl inside the PROLOG section
# CalPatRec: calorimeter-seeded track finding
# CalPatRec uses its own instance of the hit flags
# DoubletAmbigResolver is defined in TrkReco/fcl/prolog.fcl
#------------------------------------------------------------------------------
BEGIN_PROLOG
#------------------------------------------------------------------------------
# there seems to be a circular dependence between MakeStrawHitPositions and 
# FlagStrawHits ... FlagBkgHits ?
# MakeStrawHitPositions stores the hit flag in StrawHitPosition object
# for that, an existing StrawHitFlagCollection is required
#
# in its turn, the FlagStrawHits module flags if the corresponding hit 
# position 'stereo' and also sets radial selection flag
# it also sets 'timesel' and 'energysel' flags
# if, however, the StrawHitPosition doesnt exist, the 'stereo' and 'radsel' 
# flags are not set
#
# FlagBkgHits produces yet another hit flag collection, copying flags set by 
# the OR of FlagStrawHits and flags stored in StrawHitPositions, and potentially adding 
# a 'delta' and 'isolated' flags
# in principle, FlagBkgHits also uses StereoHitCollection, but that is not a must
#
# yes, there is a circular dependence between the data products.
# Dave runs several instances of the hit flagging modules for a reason
#------------------------------------------------------------------------------ 
#-----------------------------------------------------------------------------
# new format
#------------------------------------------------------------------------------
CalPatRec : {
#------------------------------------------------------------------------------
# CalPatRec.HelixFinder and HelixFitHack configuratons (pattern recognition)
#------------------------------------------------------------------------------
    HelixFitHack : {
	debugLevel                              : 0
	debugLevel2                             : 0
	diagLevel                               : 0
	minNHit                                 : 10      # minimal number of hits on found helix
	hitChi2Max                              : 25.
	mostProbableDfDz                        : 0.00475
	maxDfDz                                 : 0.01
	minDfDz                                 : 0.002
	sigmaPhi                                : 0.1636  # radians
	weightXY                                : 0.2941
	weightZPhi                              : 0.174
	maxXDPhi                                : 5    #
	distPatRec                              : 100. # mm
	maxChi2TrkCandidate                     : 1500
	markCandidateHits                       : 0
	minPointsTrkCandidate                   : 25
	# confirmed on 2015-02-07
	chi2xyMax                               : 5.0    # default value is 300
	chi2zphiMax                             : 5.0    # 0.1 #default is 0.1, use 0.05 for debugging purposes
	dfdzErr                                 : 0.1
    }

    HelixFinderAlg : {
	debugLevel                              : 0
	debugLevel2                             : 0
	diagLevel                               : 0
	HelixFitSelectionBits                   : ["EnergySelection","TimeSelection","RadiusSelection"]
	BackgroundSelectionBits                 : ["Background"]
	minNHit                                 : 10      # minimal number of hits on found helix
	hitChi2Max                              : 25.
	mostProbableDfDz                        : 0.00475
	maxDfDz                                 : 0.01
	minDfDz                                 : 0.002
	sigmaPhi                                : 0.1636  # radians
	weightXY                                : 0.2941
	weightZPhi                              : 0.174
	maxXDPhi                                : 5    #
	distPatRec                              : 100. # mm
	maxChi2TrkCandidate                     : 1500
	markCandidateHits                       : 0
	minPointsTrkCandidate                   : 25
	# confirmed on 2015-02-07
	chi2xyMax                               : 5.0    # default value is 300
	chi2zphiMax                             : 5.0    # 0.1 #default is 0.1, use 0.05 for debugging puposes
	dfdzErr                                 : 0.1
    }
#------------------------------------------------------------------------------
# Kalman fitter configuration for the seed fit
#------------------------------------------------------------------------------
    SeedFitHack : {
	makeStrawHitModuleLabel                 : makeSH
	debugLevel                              : 0
	minnstraws                              : 10
	MaxIterations                           : 3
	materialCorrection                      : false
	seedsmear       			: 10000
	maxhitchi                               : 5.0
	hiterr                                  : [ 5.0  , 1.44  ]
	ambiguityStrategy       		: [ 0    , 0     ]
	t0Tolerance				: [ 5.0  , 5.0   ]
	weedhits                                : [ true , true  ]   # default:true
	AddMaterial		                : [ false, false ]
	initT0					: true 
	updateT0				: false
	T0UpdateMode                            : 1                # doesnt matter for the seed fit
	HitMinDrift 				: 0.2
	DivergeFlt                              : 1000.            #  default: 1000.
	RdriftMinusDocaTol                      : 1.
	dtOffset                                : @local::TrackCaloMatching.DtOffset
	#------------------------------------------------------------------------------
	# shouldn't be used during the seed fit, only during the hit-based fit 
	#------------------------------------------------------------------------------
	scaleErrDoublet                         : 1.
	minDriftDoublet                         : 0.3
	deltaDriftDoublet                       : 0.3
	sigmaSlope                              : 0.025
	#------------------------------------------------------------------------------
	#  parameters of KalContext 
	#------------------------------------------------------------------------------
	MinNDOF                                 : 5 # match 10 hits of HelixFit
	#------------------------------------------------------------------------------
	# ambiguity resolver parameters
	#------------------------------------------------------------------------------
	FixedAmbigResolver                      : {}
	HitAmbigResolver                        : {}
	PocaAmbigResolver                       : {}
	PanelAmbigResolver                      : {}
	#------------------------------------------------------------------------------
	# provision for doublet ambiguity resolver - SeedFit is not using it, but the
	# initialization might require
	#------------------------------------------------------------------------------
	DoubletAmbigResolver                    : { @table::TrkReco.DoubletAmbigResolver }
    }
#------------------------------------------------------------------------------
# KalFitHack configuration for the final track fit
#------------------------------------------------------------------------------
    KalFitHack : {
	debugLevel                              : 0
	materialCorrection                      : true
	mingap					: 1.0
	ambiguityStrategy    			: [ 4    , 4    , 4    , 4   , 4    , 4    , 4    , 4   , 4    ]
	hiterr 					: [ 5.0  , 1.5  , 0.5  , 0.25, 0.125, 0.05 , 0.0  , 0.0 , 0.0  ]
	t0Tolerance				: [ 2.0  , 1.0  , 1.0  , 1.0 , 0.5  , 0.5  , 0.2  , 0.2 , 0.1  ]
	weedhits                                : [ true , true , true , true, true , true , true , true, true ]
	# did Dave mean that? 
	AddMaterial		                : [ false, false, false, true, false, false, false, true, true ]
	initT0					: true
	updateT0				: true
	T0UpdateMode                            : 1
	HitAmbigPenalty 			: false
	HitMinDrift				: 0.2
	DivergeFlt                              : 1000.
	RdriftMinusDocaTol                      : 1.
	ZeroDriftPenalty 			: 0.05
	Neutralize 				: true
	#------------------------------------------------------------------------------
	#  KalContext parameters  (there are more to define ! )
	#------------------------------------------------------------------------------
	MinNDOF                                 : 10 # this means 15 hits min
	#------------------------------------------------------------------------------
	# ambiguity resolver parameters
	#------------------------------------------------------------------------------
	FixedAmbigResolver                      : {}
	HitAmbigResolver                        : {}
	PocaAmbigResolver                       : {}
	PanelAmbigResolver                      : {}
	#------------------------------------------------------------------------------
	# doublet-based ambiguity resolver parameters
	#------------------------------------------------------------------------------
	DoubletAmbigResolver                    : { @table::TrkReco.DoubletAmbigResolver }
	fieldCorrection				: true
	maxhitchi                               : 3.5
	dtOffset                                : @local::TrackCaloMatching.DtOffset
	scaleErrDoublet                         : 5.
	#	iLoopUseDoublets                        : 9
	minDriftDoublet                         : 0.3
	deltaDriftDoublet                       : 0.3
	sigmaSlope                              : 0.025
	makeStrawHitModuleLabel                 : makeSH
    }
#------------------------------------------------------------------------------
# SeedFitter(SeedFitHackNew) configuration for the final track fit
#------------------------------------------------------------------------------
    SeedFitter : {
	debugLevel                              : 0
	minnstraws                              : 10
	MaximumMaterialFlightDifference         : 1000 # mm separation in flightlength
	materialCorrection                      : false
	MaxIterations                           : 3
	seedsmear       			: 10000
	weedhits                                : [ true , true  ]   # default:true
	maxhitchi                               : 5.0
	maxweed                                 : 10
	maxDriftPull                            : 10.
	makeStrawHitModuleLabel                 : makeSH
	removeFailedFits                        : false
	ambiguityStrategy       		: [ 0    , 0     ]
#	hiterr                                  : [ 5.0  , 1.44  ]
	hiterr                                  : [ 5.0  , 3.    ]
	AddMaterial		                : [ false, false ]
	t0Tolerance				: [ 5.0  , 5.0   ]
	minT0DOCA                               : -0.2               # 
	t0window                                : 2.5
	dtOffset                                : @local::TrackCaloMatching.DtOffset
	updateT0				: false
	updateT0Mode                            : 1                # IMPORTANT here!
	HitMinDrift 				: 0.2
	DivergeFlt                              : 1000.            #  default: 1000.
	RdriftMinusDocaTol                      : 1.
	daveMode                                : 0
	#------------------------------------------------------------------------------
	# shouldn't be used during the seed fit, only during the hit-based fit 
	#------------------------------------------------------------------------------
	scaleErrDoublet                         : 1.
	minDriftDoublet                         : 0.3
	deltaDriftDoublet                       : 0.3
	maxDoubletChi2                          : -1    # not used !
	sigmaSlope                              : 0.025
	#------------------------------------------------------------------------------
	#  parameters of KalContext 
	#------------------------------------------------------------------------------
	MinNDOF                                 : 5 # match 10 hits of HelixFit
	#------------------------------------------------------------------------------
	# ambiguity resolver parameters
	#------------------------------------------------------------------------------
	FixedAmbigResolver                      : {}
	HitAmbigResolver                        : {}
	PocaAmbigResolver                       : {}
	PanelAmbigResolver                      : {}
	#------------------------------------------------------------------------------
	# provision for doublet ambiguity resolver - SeedFit is not using it, but the
	# initialization might require
	#------------------------------------------------------------------------------
	DoubletAmbigResolver                    : { @table::TrkReco.DoubletAmbigResolver }
    }
#------------------------------------------------------------------------------
# KalFitter(KalFitHackNew) configuration for the final track fit
#------------------------------------------------------------------------------
    KalFitter : {
	debugLevel                              : 0
	minnstraws                              : 15
	MaximumMaterialFlightDifference         : 1000 # mm separation in flightlength
	materialCorrection                      : true
	weedhits                                : [ true , true , true , true, true , true , true , true, true ]
	maxhitchi                               : 5. # 3.5
	maxDriftPull                            : 10.
	maxweed                                 : 10
	mingap					: 1.0
	makeStrawHitModuleLabel                 : makeSH
	removeFailedFits                        : false
	ambiguityStrategy    			: [ 4    , 4    , 4    , 4   , 4    , 4    , 4    , 4   , 4    ]
	AddMaterial		                : [ false, false, false, true, false, false, false, true, true ]
	hiterr 					: [ 5.0  , 1.5  , 0.5  , 0.25, 0.125, 0.05 , 0.0  , 0.0 , 0.0  ]
	t0Tolerance				: [ 2.0  , 1.0  , 1.0  , 1.0 , 0.5  , 0.5  , 0.2  , 0.2 , 0.1  ]
	# not used t0ErrorFactor                           : 1.2                # scale ?
	minT0DOCA                               : -0.2               # 
	t0window                                : 2.5
	dtOffset                                : @local::TrackCaloMatching.DtOffset
	# did Dave mean that? 
	updateT0				: true
	updateT0Mode                            : 1 # 0: always use cluster time, if available;  1: use cluster time just once
	HitAmbigPenalty 			: false
	HitMinDrift				: 0.2
	DivergeFlt                              : 1000.
	RdriftMinusDocaTol                      : 1.
	daveMode                                : 0
	ZeroDriftPenalty 			: 0.05
	Neutralize 				: true
	#------------------------------------------------------------------------------
	#  KalContext parameters  (there are more to define ! )
	#------------------------------------------------------------------------------
	MinNDOF                                 : 10 # this means 15 hits min
	#------------------------------------------------------------------------------
	# ambiguity resolver parameters
	#------------------------------------------------------------------------------
	FixedAmbigResolver                      : {}
	HitAmbigResolver                        : {}
	PocaAmbigResolver                       : {}
	PanelAmbigResolver                      : {}
	#------------------------------------------------------------------------------
	# doublet-based ambiguity resolver parameters
	#------------------------------------------------------------------------------
	DoubletAmbigResolver                    : { @table::TrkReco.DoubletAmbigResolver }
	fieldCorrection				: true
	scaleErrDoublet                         : 5.
	minDriftDoublet                         : 0.3
	deltaDriftDoublet                       : 0.3
	maxDoubletChi2                          : 9
	sigmaSlope                              : 0.025
    }
}
#------------------------------------------------------------------------------
#  module
#------------------------------------------------------------------------------
CalPatRec : { @table::CalPatRec 
    producers : { 
	CalPatRec : { module_type:CalPatRec
	    TimeOffsets                                 : { inputs : [ "protonTimeMap", "muonTimeMap" ] }
	    StrawHitCollectionLabel                     : makeSH
	    StrawDigiCollectionLabel                    : makeSD
	    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits		 
	    StrawHitPositionCollectionLabel             : CalPatRecMakeStrawHitPositions 
	    caloReadoutModuleLabel                      : MakeCaloReadoutHits		 
	    calorimeterHitMCCrystalPtr                  : CaloHitMCCrystalPtr		 
	    caloClusterModuleLabel                      : CaloClusterFromProtoCluster                
	    #------------------------------------------------------------------------------
	    #  now this is defined by the ambig resolver choice 
	    #------------------------------------------------------------------------------
	    #    useDoublets             : 1
	    diagLevel                                   : 0
	    debugLevel                                  : 0
	    printFrequency                              : 100
	    addhits                                     : true
	    final                                       : 1
	    fitparticle                                 : @local::Particle.eminus
	    fitdirection                                : @local::FitDir.downstream
	    MinNHits                                    : 15
	    DtMin                                       : -40.
	    DtMax                                       :  40.   # make it symmetric
	    MaxDtMiss                                   : 55.
	    
	    tmin                                        : 0.
	    tmax                                        : 2000.  # ns
	    minClusterEnergy                            : 50.    # MeV
	    minClusterSize                              : 2      # number of crystals
	    MaxHelixDoca                                : 60.    # in mm
	    MaxAddDoca                                  : 7.     # in mm
	    MaxAddChi                                   : 3.5    # normalized unit
	    MaxStrawEDep                                : 0.005  # max charge for electron (mu2e-7329)
	    TimeSelectionBits                           : ["EnergySelection","TimeSelection","RadiusSelection"]
	    HelixFitSelectionBits                       : ["EnergySelection","TimeSelection","RadiusSelection"]
	    KalmanFitSelectionBits                      : []
	    BackgroundSelectionBits                     : ["Background","Isolated"]

	    HelixFitHack : { @table::CalPatRec.HelixFitHack }
	    SeedFitHack  : { @table::CalPatRec.SeedFitHack  }
	    KalFitHack   : { @table::CalPatRec.KalFitHack   }
	}

	MergeHelixFinder : { module_type:MergeHelixFinder	
	    diagLevel                    : 0
	    debugLevel                   : 0
	    minTprChi2                   : 100 
	    minCprChi2                   : 100
	    trkHelixFinderModuleLabel    : "PosHelixFinder"
	    calHelixFinderModuleLabel    : "CalHelixFinder"
	}

	MergePatRec : { module_type:MergePatRec
	    diagLevel                    : 0
	    debugLevel                   : 0
	    trkPatRecModuleLabel         : KFFDeM
	    calPatRecModuleLabel         : CalTrkFit
	    KalDiag                      : { @table::KalDiagDirect
		FillMCInfo               : false
	    }  # clone from  TrkRecFit

	    DoubletAmbigResolver         : { @table::TrkReco.DoubletAmbigResolver }

	    trkPatRecMVA                 : {
		MVAWeights               : "CalPatRec/data/v5_7_7/MLP_weights_logfcons_1_lin.xml"
		MVAType                  : 0
		trkQualHist              : "CalPatRec/data/v5_7_7/tpr_qual_logfcons_2_exp.tab"
		minTrkQual               : 0.4
	    }

	    calPatRecMVA                 : {
		MVAWeights               : "CalPatRec/data/v5_7_7/MLP_weights_logfcons_1_lin.xml"
		MVAType                  : 0
		trkQualHist              : "CalPatRec/data/v5_7_7/cpr_qual_logfcons_1_lin.tab"
		minTrkQual               : 0.65
	    }
#------------------------------------------------------------------------------
# distributions for the ANN training variable
#------------------------------------------------------------------------------
	}
    }
}
#------------------------------------------------------------------------------
# producers
#------------------------------------------------------------------------------
CalPatRec : { @table::CalPatRec 

    producers : { @table::CalPatRec.producers

	CalPatRecFSHP : {
	    module_type                     : FlagStrawHits
	    StrawHitCollectionLabel         : makeSH
	    StrawHitPositionCollectionLabel : ""
	    maximumEnergy                   : 0.005   # 5 KeV, in MeV
	}

	CalPatRecMakeStrawHitPositions : {
	    module_type                 : MakeStrawHitPositions
	    StrawHitCollection          : makeSH
	    StrawHitFlagCollection      : CalPatRecFSHP
	    diagLevel                   : 0
	    printHits                   : 0
	}

	CalPatRecMakeStereoHits         : {
	    module_type                 : MakeStereoHits
	    StrawHitCollectionLabel     : makeSH
	    StrawHitPositionCollection  : CalPatRecMakeStrawHitPositions
	    StrawHitFlagCollection      : CalPatRecFSHP
	    MVATool                     : { MVAWeights : "HitMakers/test/StereoMVA.weights.xml" }
	    diagLevel                   : 0
	    printHits                   : 0
	}

	CalPatRecFlagStrawHits              : {
	    module_type                     : FlagStrawHits
	    StrawHitCollectionLabel         : makeSH
	    StrawHitPositionCollectionLabel : CalPatRecMakeStereoHits
	    minimumRadius                   : 380.            # mm
	    maximumRadius                   : 700.  # mm
	    maximumEnergy                   : 0.005           # 5 KeV, in MeV
	}

	CalPatRecFlagBkgHits                : { @table::FlagBkgHits
	    StrawHitCollectionLabel         : makeSH
	    StrawHitFlagCollectionLabel     : CalPatRecFlagStrawHits
	    StrawHitPositionCollectionLabel : CalPatRecMakeStereoHits
	    # make sure the stereo hit collection name is undefined , 
	    # according to the  comments this shouldn't change anything
	    StereoHitCollectionLabel        : ""
	}
#------------------------------------------------------------------------------
# default configuration: DEM
# CalPatRec, so far, has been validated only for e- 
#------------------------------------------------------------------------------
# 	CalTrkFitDem : { @table::CalPatRec.producers.CalPatRec fitparticle: 11 fitdirection:0 }
# 	CalTrkFitDmm : { @table::CalPatRec.producers.CalPatRec fitparticle: 13 fitdirection:0 }
# 	CalTrkFitDep : { @table::CalPatRec.producers.CalPatRec fitparticle:-11 fitdirection:0 }
# 	CalTrkFitDmp : { @table::CalPatRec.producers.CalPatRec fitparticle:-13 fitdirection:0 }
# 
	MergeHelixFinderCpr : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : none
	    calHelixFinderModuleLabel : CalHelixFinder
	    fitparticle          : @local::Particle.eminus
	    fitdirection         : @local::FitDir.downstream
	}

	MergeHelixFinderTpr : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : PosHelixFinder
	    calHelixFinderModuleLabel : none
	    fitparticle          : @local::Particle.eminus
	    fitdirection         : @local::FitDir.downstream
	}

	MergeHelixFinderDem : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : PosHelixFinderDem
	    calHelixFinderModuleLabel : CalHelixFinderDem
	}

	MergeHelixFinderDmm : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : PosHelixFinderDmm
	    calHelixFinderModuleLabel : CalHelixFinderDmm
	}

	MergeHelixFinderDep : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : NegHelixFinderDep
	    calHelixFinderModuleLabel : none
	}

	MergeHelixFinderDmp : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : NegHelixFinderDmp
	    calHelixFinderModuleLabel : none
	}

	MergeHelixFinderUem : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : NegHelixFinderUem
	    calHelixFinderModuleLabel : none
	}

	MergeHelixFinderUmm : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : NegHelixFinderUmm
	    calHelixFinderModuleLabel : none
	}

	MergeHelixFinderUep : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : PosHelixFinderUep
	    calHelixFinderModuleLabel : none
	}

	MergeHelixFinderUmp : { @table::CalPatRec.producers.MergeHelixFinder 
	    trkHelixFinderModuleLabel : PosHelixFinderUmp
	    calHelixFinderModuleLabel : none
	}

	MergePatRecCpr : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: none    calPatRecModuleLabel: CalTrkFit    }
	MergePatRecTpr : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFDeM  calPatRecModuleLabel: none         }
	MergePatRecDem : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFDeM  calPatRecModuleLabel: CalTrkFitDem }
	MergePatRecDmm : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFDmuM calPatRecModuleLabel: CalTrkFitDmm }
	MergePatRecDep : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFDeP  calPatRecModuleLabel: none         }
	MergePatRecDmp : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFDmuP calPatRecModuleLabel: none         }
	MergePatRecUem : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFUeM  calPatRecModuleLabel: none         }
	MergePatRecUmm : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFUmuM calPatRecModuleLabel: none         }
	MergePatRecUep : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFUeP  calPatRecModuleLabel: none         }
	MergePatRecUmp : { @table::CalPatRec.producers.MergePatRec trkPatRecModuleLabel: KFFUmuP calPatRecModuleLabel: none         }
    }

    filters : { 
#------------------------------------------------------------------------------
# new modules
#------------------------------------------------------------------------------
	CalTimePeakFinder          : { module_type:CalTimePeakFinder
	    diagLevel                                   : 0
	    debugLevel                                  : 0
	    printFrequency                              : 100
	    useAsFilter                                 : 0
	    StrawHitCollectionLabel                     : makeSH
	    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits
	    caloClusterModuleLabel                      : CaloClusterFromProtoCluster
#	    HelixFitSelectionBits                       : ["EnergySelection","TimeSelection","RadiusSelection"]
#	    BackgroundSelectionBits                     : ["Background", "Isolated"]
	    HelixFitSelectionBits                       : ["EnergySelection","TimeSelection"]
	    BackgroundSelectionBits                     : ["Background"]
	    MinNHits                                    : 15
	    DtMin                                       : -40.
	    DtMax                                       :  40.   # make it symmetric
	    minClusterEnergy                            : 50.    # MeV
	    minClusterSize                              : 2      # number of crystals
	    minClusterTime                              : 500.   # ns
	    pitchAngle                                  : 0.67   # mean pitch for CE
	    dtOffset                                    : @local::TrackCaloMatching.DtOffset
	    histograms                                  : { 
		tool_type                               : "CalTimePeakFinderHist" 
		mcTruth                                 : 0 
		mcUtils                                 : { tool_type : "CalPatRecMcUtils" }
	    }
	}

	CalHelixFinder          : { module_type:CalHelixFinder
	    diagLevel                                   : 0
	    debugLevel                                  : 0
	    printFrequency                              : 100
	    useAsFilter                                 : 0
	    StrawHitCollectionLabel                     : makeSH
	    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits
	    StrawHitPositionCollectionLabel             : CalPatRecMakeStrawHitPositions
	    TimeClusterCollectionLabel                  : CalTimePeakFinder
	    fitparticle                                 : @local::Particle.eminus
	    fitdirection                                : @local::FitDir.downstream

	    # HelixFinderAlg configuraton (pattern recognition)
	    HelixFinderAlg                              : { @table::CalPatRec.HelixFinderAlg }
	    histograms                                  : { 
		tool_type                               : "CalHelixFinderHist" 
		mcTruth                                 : 1
		mcUtils                                 : { tool_type : "CalPatRecMcUtils" }
	    }
	}

	CalSeedFit : { module_type:CalSeedFit
	    diagLevel                                   : 0
	    debugLevel                                  : 0
	    printFrequency                              : 100
	    useAsFilter                                 : 0
	    rescueHits                                  : 1
	    StrawHitCollectionLabel                     : makeSH			 
	    StrawDigiCollectionLabel                    : makeSD
	    StrawHitPositionCollectionLabel             : CalPatRecMakeStrawHitPositions	 
	    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits 
	    HelixSeedModuleLabel                        : CalHelixFinder
	    CalTimePeakModuleLabel                      : CalTimePeakFinder
	    MaxDtMiss                                   : 55.
	    MaxAddDoca                                  : 7.    # mm
	    MaxAddChi                                   : 5.    # normalized unit
	    fitparticle                                 : @local::Particle.eminus
	    fitdirection                                : @local::FitDir.downstream
	    Fitter                                      : { @table::CalPatRec.SeedFitter }
	    TimeOffsets                                 : { inputs : [ "protonTimeMap", "muonTimeMap" ] }
	    ParameterErrors                             : [10.0,0.05,0.001,10.0,0.05]
	    histograms                                  : { 
		tool_type                               : "CalSeedFitHist"
		mcTruth                                 : 1
		mcUtils                                 : { tool_type : "CalPatRecMcUtils" }
	    }	    
	}

	CalTrkFit : { module_type:CalTrkFit
	    diagLevel                                   : 0
	    debugLevel                                  : 0
	    printFrequency                              : 100
	    useAsFilter                                 : 0
	    addhits                                     : true
	    StrawHitCollectionLabel                     : makeSH
	    StrawDigiCollectionLabel                    : makeSD
	    StrawHitPositionCollectionLabel             : CalPatRecMakeStrawHitPositions	 
	    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits 
	    TrackSeedModuleLabel                        : CalSeedFit
	    CalTimePeakModuleLabel                      : CalTimePeakFinder
	    MaxDtMiss                                   : 55.
	    MaxAddDoca                                  : 5.    # mm
	    MaxAddChi                                   : 5.    # 3.5 used by unweedHits and addHits
	    GoodKalSeedFitBits                          : ["SeedOK"]
	    fitparticle                                 : @local::Particle.eminus
	    fitdirection                                : @local::FitDir.downstream
	    Fitter                                      : { @table::CalPatRec.KalFitter }
	    TimeOffsets                                 : { inputs : [ "protonTimeMap", "muonTimeMap" ] }
	    histograms                                  : { 
		tool_type                               : "CalTrkFitHist" 
		mcTruth                                 : 1
		mcUtils                                 : { tool_type : "CalPatRecMcUtils" }
	    }
	}
    }
}

CalPatRecFSHP                  : { @table::CalPatRec.producers.CalPatRecFSHP                  }
CalPatRecMakeStrawHitPositions : { @table::CalPatRec.producers.CalPatRecMakeStrawHitPositions }
CalPatRecMakeStereoHits        : { @table::CalPatRec.producers.CalPatRecMakeStereoHits        }
CalPatRecFlagStrawHits         : { @table::CalPatRec.producers.CalPatRecFlagStrawHits         }
CalPatRecFlagBkgHits           : { @table::CalPatRec.producers.CalPatRecFlagBkgHits           }
#------------------------------------------------------------------------------
# calorimeter-seeded tracking makes sense only for downstream particles
#------------------------------------------------------------------------------
# CalTimePeakFinder              : { @table::CalPatRec.filters.CalTimePeakFinder }
# CalHelixFinder                 : { @table::CalPatRec.filters.CalHelixFinder    }
# CalSeedFit                     : { @table::CalPatRec.filters.CalSeedFit        }
# CalTrkFit                      : { @table::CalPatRec.filters.CalTrkFit         }

CalPatRec: { @table::CalPatRec 
    filters : { @table::CalPatRec.filters
	CalTimePeakFinderDem           : { @table::CalPatRec.filters.CalTimePeakFinder }
	CalTimePeakFinderDmm           : { @table::CalPatRec.filters.CalTimePeakFinder fitparticle: @local::Particle.muminus }
	CalTimePeakFinderDep           : { @table::CalPatRec.filters.CalTimePeakFinder fitparticle: @local::Particle.eplus   }
	CalTimePeakFinderDmp           : { @table::CalPatRec.filters.CalTimePeakFinder fitparticle: @local::Particle.muplus  } 

	CalHelixFinderDem              : { @table::CalPatRec.filters.CalHelixFinder    
	    TimeClusterCollectionLabel : CalTimePeakFinderDem
	}
	CalHelixFinderDmm              : { @table::CalPatRec.filters.CalHelixFinder 
	    fitparticle                : @local::Particle.muminus 
	    TimeClusterCollectionLabel : CalTimePeakFinderDmm
	}
	CalHelixFinderDep              : { @table::CalPatRec.filters.CalHelixFinder 
	    fitparticle                : @local::Particle.eplus
	    TimeClusterCollectionLabel : CalTimePeakFinderDep
	}
	CalHelixFinderDmp              : { @table::CalPatRec.filters.CalHelixFinder 
	    fitparticle                : @local::Particle.muplus 
	    TimeClusterCollectionLabel : CalTimePeakFinderDmp
	}

	CalSeedFitDem                  : { @table::CalPatRec.filters.CalSeedFit        
	    HelixSeedModuleLabel       : CalHelixFinderDem
	    CalTimePeakModuleLabel     : CalTimePeakFinderDem
	}
	CalSeedFitDmm                  : { @table::CalPatRec.filters.CalSeedFit 
	    fitparticle                : @local::Particle.muminus
	    HelixSeedModuleLabel       : CalHelixFinderDmm
	    CalTimePeakModuleLabel     : CalTimePeakFinderDmm
	}
	CalSeedFitDep                  : { @table::CalPatRec.filters.CalSeedFit 
	    fitparticle                : @local::Particle.eplus  
	    HelixSeedModuleLabel       : CalHelixFinderDep
	    CalTimePeakModuleLabel     : CalTimePeakFinderDep
	}
	CalSeedFitDmp                  : { @table::CalPatRec.filters.CalSeedFit 
	    fitparticle                : @local::Particle.muplus
	    HelixSeedModuleLabel       : CalHelixFinderDmp
	    CalTimePeakModuleLabel     : CalTimePeakFinderDmp
	}

	CalTrkFitDem                   : { @table::CalPatRec.filters.CalTrkFit         
	    TrackSeedModuleLabel       : CalSeedFitDem
	    CalTimePeakModuleLabel     : CalTimePeakFinderDem
	}
	CalTrkFitDmm                   : { @table::CalPatRec.filters.CalTrkFit 
	    fitparticle                : @local::Particle.muminus 
	    TrackSeedModuleLabel       : CalSeedFitDmm
	    CalTimePeakModuleLabel     : CalTimePeakFinderDmm
	}
	CalTrkFitDep                   : { @table::CalPatRec.filters.CalTrkFit 
	    fitparticle                : @local::Particle.eplus  
	    TrackSeedModuleLabel       : CalSeedFitDep
	    CalTimePeakModuleLabel     : CalTimePeakFinderDep
	}
	CalTrkFitDmp                   : { @table::CalPatRec.filters.CalTrkFit 
	    fitparticle                : @local::Particle.muplus 
	    TrackSeedModuleLabel       : CalSeedFitDmp
	    CalTimePeakModuleLabel     : CalTimePeakFinderDmp
	}
   }
}


# MergePatRecDem  : { @table::CalPatRec.producers.MergePatRecDem }
# MergePatRecDmm  : { @table::CalPatRec.producers.MergePatRecDmm }
# MergePatRecDep  : { @table::CalPatRec.producers.MergePatRecDep }
# MergePatRecDmp  : { @table::CalPatRec.producers.MergePatRecDmp }
# MergePatRecUem  : { @table::CalPatRec.producers.MergePatRecUem }
# MergePatRecUmm  : { @table::CalPatRec.producers.MergePatRecUmm }
# MergePatRecUep  : { @table::CalPatRec.producers.MergePatRecUep }
# MergePatRecUmp  : { @table::CalPatRec.producers.MergePatRecUmp }

CalPatRec.prepare_hits : [ makeSH, CalPatRecFSHP, CalPatRecMakeStrawHitPositions, CalPatRecMakeStereoHits,  
			   CalPatRecFlagStrawHits, CalPatRecFlagBkgHits ]

CalPatRec.old_reco : [ @sequence::CalPatRec.prepare_hits, CalPatRec ]

CalPatRec.reco     : [ @sequence::CalPatRec.prepare_hits, CalTimePeakFinder   , CalHelixFinder   , CalSeedFit   , CalTrkFit    ]
CalPatRec.dem_reco : [ @sequence::CalPatRec.prepare_hits, CalTimePeakFinderDem, CalHelixFinderDem, CalSeedFitDem, CalTrkFitDem ]
CalPatRec.dep_reco : [ @sequence::CalPatRec.prepare_hits, CalTimePeakFinderDep, CalHelixFinderDep, CalSeedFitDep, CalTrkFitDep ]
CalPatRec.dmm_reco : [ @sequence::CalPatRec.prepare_hits, CalTimePeakFinderDmm, CalHelixFinderDmm, CalSeedFitDmm, CalTrkFitDmm ]
CalPatRec.dmp_reco : [ @sequence::CalPatRec.prepare_hits, CalTimePeakFinderDmp, CalHelixFinderDmp, CalSeedFitDmp, CalTrkFitDmp ]

END_PROLOG
