# -*- mode: tcl -*-
#------------------------------------------------------------------------------
# this file is included by fcl/standardProducers.fcl inside the PROLOG section
# CalPatRec: calorimeter-seeded track finding
# CalPatRec uses its own instance of the hit flags
# DoubletAmbigResolver is defined in TrkReco/fcl/prolog.fcl
#------------------------------------------------------------------------------
BEGIN_PROLOG
#------------------------------------------------------------------------------
# there seems to be a circular dependence between MakeStrawHitPositions and 
# FlagStrawHits ... FlagBkgHits ?
# MakeStrawHitPositions stores the hit flag in StrawHitPosition object
# for that, an existing StrawHitFlagCollection is required
#
# in its turn, the FlagStrawHits module flags if the corresponding hit 
# position 'stereo' and also sets radial selection flag
# it also sets 'timesel' and 'energysel' flags
# if, however, the StrawHitPosition doesnt exist, the 'stereo' and 'radsel' 
# flags are not set
#
# FlagBkgHits produces yet another hit flag collection, copying flags set by 
# the OR of FlagStrawHits and flags stored in StrawHitPositions, and potentially adding 
# a 'delta' and 'isolated' flags
# in principle, FlagBkgHits also uses StereoHitCollection, but that is not a must
#
# yes, there is a circular dependence between the data products.
# Dave runs several instances of the hit flagging modules for a reason
#------------------------------------------------------------------------------ 
CalPatRecFSHP : {
    module_type                     : FlagStrawHits
    StrawHitCollectionLabel         : makeSH
    StrawHitPositionCollectionLabel : ""
    maximumEnergy                   : 0.005   # 5 KeV, in MeV
}

CalPatRecMakeStrawHitPositions : {
    module_type                 : MakeStrawHitPositions
    StrawHitCollectionLabel     : makeSH
    StrawHitFlagCollectionLabel : CalPatRecFSHP
    diagLevel                   : 0
    printHits                   : 0
}

CalPatRecMakeStereoHits : {
    module_type                 : MakeStereoHits
    StrawHitCollectionLabel     : makeSH
    StrawHitFlagCollectionLabel : CalPatRecFSHP
    MVATool                     : { MVAWeights : "HitMakers/test/StereoMVA.weights.xml" }
    diagLevel                   : 0
    printHits                   : 0
}

CalPatRecFlagStrawHits : {
    module_type                     : FlagStrawHits
    StrawHitCollectionLabel         : makeSH
    StrawHitPositionCollectionLabel : CalPatRecMakeStereoHits
    minimumRadius                   : 380.            # mm
    maximumRadius                   : [700., 700. ]   # mm
    maximumEnergy                   : 0.005           # 5 KeV, in MeV
}

CalPatRecFlagBkgHits : { @table::FlagBkgHits
    StrawHitCollectionLabel         : makeSH
    StrawHitFlagCollectionLabel     : CalPatRecFlagStrawHits
    StrawHitPositionCollectionLabel : CalPatRecMakeStereoHits
# make sure the stereo hit collection name is undefined , 
# according to the  comments this shouldn't change anything
    StereoHitCollectionLabel        : ""
}

CalPatRec            : {
    module_type                                 : CalPatRec

    TimeOffsets                                 :  { inputs : [ "protonTimeMap", "muonTimeMap" ] }

    StrawHitCollectionLabel                     : makeSH
    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits
    StrawHitPositionCollectionLabel             : CalPatRecMakeStrawHitPositions
    caloReadoutModuleLabel                      : MakeCaloReadoutHits
    calorimeterHitMCCrystalPtr                  : CaloHitMCCrystalPtr
    caloClusterModuleLabel                      : MakeCaloCluster
#------------------------------------------------------------------------------
#  now this is defined by the ambig resolver choice 
#------------------------------------------------------------------------------
#    useDoublets             : 1
    diagLevel                                   : 0
    debugLevel                                  : 0
    printFrequency                              : 100
    addhits                                     : true
    final                                       : 1
    fitparticle                                 : 11     # 11:electron, -11:positron, 13:mu-, -13: mu+
    fitdirection                                : 0      # 0:downstream, 1:upstream
    MinNHits                                    : 15
    DtMin                                       : -40.
    DtMax                                       :  40.   # make it symmetric
    MaxStrawEDep                                : 0.005  # max integrated pulse for electron
    MaxDtMiss                                   : 55.
    
    tmin                                        : 0.
    tmax                                        : 2000.  # ns
    minClusterEnergy                            : 50.    # MeV
    minClusterSize                              : 2      # number of crystals
    MaxHelixDoca                                : 60.    # in mm
    MaxAddDoca                                  : 7.     # in mm
    MaxAddChi                                   : 3.5    # normalized unit
    MaxStrawEDep                                : 0.005
    TimeSelectionBits                           : ["EnergySelection","TimeSelection","RadiusSelection"]
    HelixFitSelectionBits                       : ["EnergySelection","TimeSelection","RadiusSelection"]
    KalmanFitSelectionBits                      : []
    BackgroundSelectionBits                     : ["DeltaRay","Isolated"]

    # HelixFitHack configuraton (pattern recognition)
    HelixFitHack : {
	debugLevel                              : 0
	debugLevel2                             : 0
	diagLevel                               : 0
	minNHit                                 : 10      # minimal number of hits on found helix
	hitChi2Max                              : 25.
	mostProbableDfDz                        : 0.00475
	maxDfDz                                 : 0.01
	minDfDz                                 : 0.002
	sigmaPhi                                : 0.1  # radians
	maxXDPhi                                : 5    #
	distPatRec                              : 100. # mm
	maxChi2TrkCandidate                     : 1500
	markCandidateHits                       : 0
	minPointsTrkCandidate                   : 25
# confirmed on 2015-02-07
	chi2xyMax                               : 5.0    # default value is 300
	chi2zphiMax                             : 5.0    # 0.1 #default is 0.1, use 0.05 for debugging puposes
	dfdzErr                                 : 0.1
    }
#------------------------------------------------------------------------------
# Kalman fitter configuration for the seed fit
#------------------------------------------------------------------------------
    SeedFitHack : {
	makeStrawHitModuleLabel                 : makeSH
	debugLevel                              : 0
	minnstraws                              : 10
	maxiter                                 : 3
	materialCorrection                      : false
	seedsmear       			: 10000
	maxhitchi                               : 5.0
	hiterr                                  : [ 5.0  , 1.44  ]
	ambiguityStrategy       		: [ 0    , 0     ]
	t0Tolerance				: [ 5.0  , 5.0   ]
	weedhits                                : [ true , true  ]   # default:true
	AddMaterial		                : [ false, false ]
 	initT0					: true 
	updateT0				: false
	T0UpdateMode                            : 1                # doesnt matter for the seed fit
	HitMinDrift 				: 0.2
	DivergeFlt                              : 1000.            #  default: 1000.
	RdriftMinusDocaTol                      : 1.
	dtOffset                                : @local::TrackCaloMatchingDtOffset
#------------------------------------------------------------------------------
# shouldn't be used during the seed fit, only during the hit-based fit 
#------------------------------------------------------------------------------
	scaleErrDoublet                         : 1.
	minDriftDoublet                         : 0.3
	deltaDriftDoublet                       : 0.3
	sigmaSlope                              : 0.025
#------------------------------------------------------------------------------
#  parameters of KalContext 
#------------------------------------------------------------------------------
	MinNDOF                                 : 5 # match 10 hits of HelixFit
#------------------------------------------------------------------------------
# ambiguity resolver parameters
#------------------------------------------------------------------------------
	FixedAmbigResolver                      : {}
	HitAmbigResolver                        : {}
	PocaAmbigResolver                       : {}
	PanelAmbigResolver                      : {}
#------------------------------------------------------------------------------
# provision for doublet ambiguity resolver - SeedFit is not using it, but 
# initialization might require
#------------------------------------------------------------------------------
	DoubletAmbigResolver                    : { @table::DoubletAmbigResolver }
    }
#------------------------------------------------------------------------------
# KalFitHack configuration for the final track fit
#------------------------------------------------------------------------------
    KalFitHack : {
	debugLevel                              : 0
	materialCorrection                      : true
	mingap					: 1.0
	ambiguityStrategy    			: [ 4    , 4    , 4    , 4   , 4    , 4    , 4    , 4   , 4    ]
	hiterr 					: [ 5.0  , 1.5  , 0.5  , 0.25, 0.125, 0.05 , 0.0  , 0.0 , 0.0  ]
	t0Tolerance				: [ 2.0  , 1.0  , 1.0  , 1.0 , 0.5  , 0.5  , 0.2  , 0.2 , 0.1  ]
	weedhits                                : [ true , true , true , true, true , true , true , true, true ]
# did Dave mean that? 
	AddMaterial		                : [ false, false, false, true, false, false, false, true, true ]
	initT0					: true
	updateT0				: true
	T0UpdateMode                            : 1
	HitAmbigPenalty 			: false
	HitMinDrift				: 0.2
	DivergeFlt                              : 1000.
	RdriftMinusDocaTol                      : 1.
	ZeroDriftPenalty 			: 0.05
	Neutralize 				: true
#------------------------------------------------------------------------------
#  KalContext parameters  (there are more to define ! )
#------------------------------------------------------------------------------
	MinNDOF                                 : 10 # this means 15 hits min
#------------------------------------------------------------------------------
# ambiguity resolver parameters
#------------------------------------------------------------------------------
	FixedAmbigResolver                      : {}
	HitAmbigResolver                        : {}
	PocaAmbigResolver                       : {}
	PanelAmbigResolver                      : {}
#------------------------------------------------------------------------------
# doublet-based ambiguity resolver parameters
#------------------------------------------------------------------------------
	DoubletAmbigResolver                    : { @table::DoubletAmbigResolver }
	fieldCorrection				: true
	maxhitchi                               : 3.5
	dtOffset                                : @local::TrackCaloMatchingDtOffset
	scaleErrDoublet                         : 5.
#	iLoopUseDoublets                        : 9
	minDriftDoublet                         : 0.3
	deltaDriftDoublet                       : 0.3
	sigmaSlope                              : 0.025
	makeStrawHitModuleLabel                 : makeSH
    }
}

CalPatRecDem : { @table::CalPatRec
    fitparticle  : 11
    fitdirection : 0
}

#------------------------------------------------------------------------------
# not sure this makes sense: muon clusters have lower energy, so to search for 
# muon tracks need to set MinClusterEnergy around 30 MeV. That would ovewhelm
# the code with the background clusters.
# For now just create a label, hopefully the module wouldn't do any harm
#------------------------------------------------------------------------------
CalPatRecDmm : { @table::CalPatRec
    fitparticle  : 13
    fitdirection : 0
}

CalTimePeakFinder          : {
    module_type                                 : CalTimePeakFinder

    diagLevel                                   : 0
    debugLevel                                  : 0
    printFrequency                              : 100
    StrawHitCollectionLabel                     : makeSH
    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits
    caloClusterModuleLabel                      : MakeCaloCluster
    HelixFitSelectionBits                       : ["EnergySelection","TimeSelection","RadiusSelection"]
    BackgroundSelectionBits                     : ["DeltaRay","Isolated"]
    MinNHits                                    : 15
    DtMin                                       : -40.
    DtMax                                       :  40.   # make it symmetric
    minClusterEnergy                            : 50.    # MeV
    minClusterSize                              : 2      # number of crystals
    pitchAngle                                  : 0.67   # mean pitch for CE
    dtOffset                                    : @local::TrackCaloMatchingDtOffset
}


CalPatRecNew          : {
    module_type                                 : CalPatRecNew

    diagLevel                                   : 0
    debugLevel                                  : 0
    printFrequency                              : 100
    StrawHitCollectionLabel                     : makeSH
    StrawHitFlagCollectionLabel                 : CalPatRecFlagBkgHits
    StrawHitPositionCollectionLabel             : CalPatRecMakeStrawHitPositions
    TrackSeedCollectionLabel                    : CalTimePeakFinder
    fitparticle                                 : 11     # 11:electron, -11:positron, 13:mu-, -13: mu+
    fitdirection                                : 0      # 0:downstream, 1:upstream

    # HelixFitHack configuraton (pattern recognition)
    HelixFitHack : {
	debugLevel                              : 0
	debugLevel2                             : 0
	diagLevel                               : 0
	minNHit                                 : 10      # minimal number of hits on found helix
	hitChi2Max                              : 25.
	mostProbableDfDz                        : 0.00475
	maxDfDz                                 : 0.01
	minDfDz                                 : 0.002
	sigmaPhi                                : 0.1  # radians
	maxXDPhi                                : 5    #
	distPatRec                              : 100. # mm
	maxChi2TrkCandidate                     : 1500
	markCandidateHits                       : 0
	minPointsTrkCandidate                   : 25
# confirmed on 2015-02-07
	chi2xyMax                               : 5.0    # default value is 300
	chi2zphiMax                             : 5.0    # 0.1 #default is 0.1, use 0.05 for debugging puposes
	dfdzErr                                 : 0.1
    }


}

#------------------------------------------------------------------------------
# default configuration: DEM
#------------------------------------------------------------------------------
MergePatRec : { module_type:MergePatRec
    diagLevel                    : 0
    debugLevel                   : 0
    trkPatRecModuleLabel         : TRFDownstreameMinus
    calPatRecModuleLabel         : CalPatRec
    fitparticle                  : 11                     # 11:electron, -11:positron, 13:mu-, -13: mu+
    fitdirection                 : 0                      # 0:downstream, 1:upstream
    KalDiag                      : { @table::KalDiagDirect
	FillMCInfo               : false
    }  # clone from  TrkRecFit
    minTrkQualA                  : 0.4
    minTrkQualB                  : 0.2
}

# TrkPatRecDownstreameMinus and TrkPatRecDownstreammuMinus are defined in TrkPatRec/fcl/prolog.fcl
# both are using the panel ambiguity resolver
MergePatRecDem : { @table::MergePatRec 
    trkPatRecModuleLabel : TRFDownstreameMinus
    calPatRecModuleLabel : CalPatRecDem
    fitparticle          : 11     # 11:electron, -11:positron, 13:mu-, -13: mu+
    fitdirection         : 0      # 0:downstream, 1:upstream
}

MergePatRecDmm : { @table::MergePatRec 
    trkPatRecModuleLabel : TRFDownstreammuMinus
    calPatRecModuleLabel : CalPatRecDmm
    fitparticle          : 13     # 11:electron, -11:positron, 13:mu-, -13: mu+
    fitdirection         : 0      # 0:downstream, 1:upstream
}

END_PROLOG
