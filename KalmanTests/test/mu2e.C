#include "TTree.h"
#include "TStyle.h"
#include "TMath.h"
#include "TFile.h"
#include "TH1F.h"
#include "TH2F.h"
#include "TF1.h"
#include "TLegend.h"
#include "TCanvas.h"
#include "TProfile.h"
#include "TCut.h"
#include "TPaveText.h"
#include "TLine.h"
#include "TRandom3.h"
#include <iostream>
#include <math.h>
#include <vector>

// the following approximation is from Czarnecki etal, 'Muon decay in orbit:spectrum of high-energy electrons',
// for E>85 MeV
Double_t DIOCZ(Double_t *x, Double_t *par) {
  double ee = x[0];
  double norm = par[0];
  static const double mal(25133);
  //    double mmu(105.654);
  static const double emu(105.194);
//  static const double emue(104.973);
  //    double me(0.511);
  static const double a5(8.6434e-17);
  static const double a6(1.16874e-17);
  static const double a7(-1.87828e-19);
  static const double a8(9.16327e-20);
  double delta = emu - ee - ee*ee/(2*mal);
  if(delta>0.0)
    return norm*(a5*pow(delta,5) + a6*pow(delta,6) + a7*pow(delta,7) + a8*pow(delta,8));
  else
    return 0.0;
}

Double_t DIOCZ_R(Double_t *x, Double_t *par) {
  double norm = par[0];
  double eloss = par[1];
  double accmid = par[2];
  double accslope = par[3];
  static const double mal(25133);
  //    double mmu(105.654);
  static const double emu(105.194);
//  static const double emue(104.973);
  //    double me(0.511);
  static const double a5(8.6434e-17);
  static const double a6(1.16874e-17);
  static const double a7(-1.87828e-19);
  static const double a8(9.16327e-20);
  static const double midmom(100.0);
  double ee = x[0]-eloss;
  double delta = emu - ee - ee*ee/(2*mal);
  if(delta>0.0)
    return (accmid + (x[0]-midmom)*accslope)*norm*(a5*pow(delta,5) + a6*pow(delta,6) + a7*pow(delta,7) + a8*pow(delta,8));
  else
    return 0.0;
}

Double_t RECODIO(Double_t *x, Double_t *par) {
  double ee = x[0];
  double mal(25133);
  double emu = 105.194 - par[0];
  double delta = emu - ee - ee*ee/(2*mal);
  if(delta > 0.0)
    return par[1]*(pow(delta,5)+par[2]*pow(delta,6)+par[3]*pow(delta,7)+par[4]*pow(delta,8));
  else
    return 0.0;
}

Double_t RECOFITDIO(Double_t *x, Double_t *par) {
  double ee = x[0];
  double mal(25133);
  double emu = 105.194 - par[0] - par[5];
  double delta = emu - ee - ee*ee/(2*mal);
  if(delta > 0.0)
    return par[6]*par[1]*(pow(delta,5)+par[2]*pow(delta,6)+par[3]*pow(delta,7)+par[4]*pow(delta,8));
  else
    return 0.0;
}

// reconstruction acceptance, as a function of the true DIO momentum
Double_t recoacc(Double_t *x, Double_t *par) {
  double accmid = par[0];
  double accslope = par[1];
  double mom = x[0];
  static const double midmom(100.0);
  return accmid + (mom-midmom)*accslope;
}

Double_t crystalball (Double_t *x, Double_t *par) {
  // par[0] : norm
  // par[1] : x0
  // par[2] : sigma
  // par[3] : n
  // par[4] : alpha
  // par[5] : fraction of exponential tail
  // par[6] : tail exponential lambda

  double dx = x[0]-par[1];
  if ( dx/fabs(par[2]) > -1.*par[4]) {
    double g = par[0]*TMath::Gaus(x[0], par[1], par[2]);
//    double g2 = par[5]*par[0]*TMath::Gaus(x[0], par[1], par[6]);
//    return g1+g2;
    double e = par[0]*par[5]*dx*exp(-(dx)/par[6])/(par[6]*par[6]);
    return g+e;
  }
  else {
    double A = pow(par[3]/fabs(par[4]), par[3])*exp(-0.5*par[4]*par[4]);
    double B = par[3]/fabs(par[4]) - fabs(par[4]);
    return par[0]*A*pow(B-dx/fabs(par[2]), -1.*par[3]);
  }
}

class mu2e {
  public:
    mu2e(TTree* d, TTree* c, double dgenrange, double nd, double nc,bool weightd=true) : dio(d), con(c),diogenrange(dgenrange),
    ndio(nd),ncon(nc),weightdio(weightd),nstopped(7.56e17),capfrac(0.609),conprob(1e-16),trueconvmom(104.973),
    tdlow(0.57735027),tdhigh(1.0),t0min(710),rpc(0.025), ap(.083333),cmu(0.041666),reco("fitstatus>0")
  {
    init();
  }
    void init();

    void fillmu2e(unsigned nbins=151,double mmin=101.0,double mmax=106.0);
    void drawmu2e(double momlow,double momhigh,const char* suffix=".png");
    void drawdio(double momlow,double momhigh,const char* suffix=".png");
    void smearDIO(unsigned ntrials=1e5,unsigned nres=1e5);
    void doExperiments(double momlow, double momhigh,double cprob,unsigned ispec,unsigned nexp=18, unsigned npave=0);
    void Write(const char* name="mu2e_spectra.root");
    void Read(const char* name="mu2e_spectra.root");
    void fitReco(unsigned icut);
  TTree *dio, *con;
    double diogenrange;
    double ndio, ncon;
    bool weightdio;
    unsigned _nbins;
    double _mmin, _mmax;
    double nstopped,capfrac,conprob;
    double decayfrac,ndecay,ncap,mevperbin,conscale;
    double trueconvmom,tdlow,tdhigh,t0min;
    double rpc, ap, cmu,flat; // rates per MeV
    double dioint,dioscale;
    unsigned mu2ecut;
    TCut reco, pitch, livegate, cosmic;
    TCut ncuts[4], t0cuts[4], momcuts[4], fitcuts[4], quality[4], final[4];
    TF1* _diocz_f;
    TF1* _cball;
    TF1* _racc;
    TF1* _reco_f;
    TF1* _flat_f[4];
    TH1F* _diospec[4];
    TH1F* _conspec[4];
    TH1D* _recodio;
    TLegend* _leg;
    TPaveText* _info;
};

void mu2e::init(){
  using namespace std;
  decayfrac = 1.0 - capfrac;
  ndecay = nstopped*decayfrac;
  ncap = nstopped*capfrac;
  conscale = ncap*conprob/ncon;
  cout << "Conversion scale factor =" << conscale << endl;
  // dio spectrum
  _diocz_f = new TF1("_diocz_f",DIOCZ,95.0,trueconvmom,1);
  _diocz_f->SetLineColor(kGreen);
  _diocz_f->SetParameter(0,1.0);
  // integrate the DIO spectrum over the range specified.  This is relative to the free decay rate
  dioint = _diocz_f->Integral(trueconvmom-diogenrange,trueconvmom);
  if(weightdio){ 
    dioscale =ndecay*diogenrange/ndio;
  } else {
    dioscale = dioint*ndecay/ndio;
  }
  cout << "DIO scale factor = " << dioscale << endl;
  flat = rpc+ap+cmu;
  cout << "Flat rate = " << flat << " counts/MeV/c" << endl;
  // basic cuts
  char ctext[80];
  snprintf(ctext,80,"td>%f&&td<%f",tdlow,tdhigh);
  pitch = TCut(ctext);
  snprintf(ctext,80,"t0>%f",t0min);
  livegate = TCut(ctext);
  cosmic = TCut("d0<105&&d0>-80 && d0+2/om>450 && d0+2/om<680");

  // cuts for different tightness of selection
  ncuts[0] = "nactive>=20";
  ncuts[1] = "nactive>=22";
  ncuts[2] = "nactive>=25";
  ncuts[3] = "nactive>=30";
  t0cuts[0] = "t0err<1.5";
  t0cuts[1] = "t0err<0.95";
  t0cuts[2] = "t0err<0.9";
  t0cuts[3] = "t0err<0.8";
  momcuts[0] = "fitmomerr<0.3";
  momcuts[1] = "fitmomerr<0.28";
  momcuts[2] = "fitmomerr<0.25";
  momcuts[3] = "fitmomerr<0.22";
  fitcuts[0] = "fitcon>1e-6";
  fitcuts[1] = "fitcon>1e-3";
  fitcuts[2] = "fitcon>2e-3";
  fitcuts[3] = "fitcon>1e-2";

  for(unsigned icut=0;icut<4;icut++){
    quality[icut] = ncuts[icut] && t0cuts[icut] && momcuts[icut] && fitcuts[icut];
    final[icut] = (reco+pitch+livegate+quality[icut]+cosmic);
  } 
  mu2ecut=2;
}

void mu2e::fillmu2e(unsigned nbins,double mmin,double mmax) {
  _nbins = nbins;
  _mmin = mmin;
  _mmax = mmax;
  mevperbin = (_mmax-_mmin)/_nbins;
  for(unsigned icut=0;icut<4;icut++){
    char dioname[50];
    snprintf(dioname,50,"diospec%i",icut);
    char conname[50];
    snprintf(conname,50,"conspec%i",icut);
    char flatname[50];
    snprintf(flatname,50,"flat_f%i",icut);

    char dtitle[100];
    snprintf(dtitle,100,"Reconstructed Momentum;p (MeV/c);N #mu2e/%2.2f MeV/c",mevperbin);
    _diospec[icut] = new TH1F(dioname,dtitle,_nbins,_mmin,_mmax);
    _diospec[icut]->SetStats(0);
    _diospec[icut]->SetLineColor(kBlue);
    _diospec[icut]->Sumw2();

    _conspec[icut] = new TH1F(conname,dtitle,_nbins,_mmin,_mmax);
    _conspec[icut]->SetStats(0);
    _conspec[icut]->SetLineColor(kRed);
    _conspec[icut]->Sumw2();

    dio->Project(dioname,"fitmom","diowt"*final[icut]);
    _diospec[icut]->Scale(dioscale);
    _diospec[icut]->SetMinimum(0.08*_diocz_f->Eval(trueconvmom-0.1)*ndecay*mevperbin);
    _diospec[icut]->SetMaximum(0.08*_diocz_f->Eval(_mmin)*ndecay*mevperbin);

    con->Project(conname,"fitmom",final[icut]);
    _conspec[icut]->Scale(conscale);

    
    _flat_f[icut] = new TF1(flatname,"[0]",_mmin,_mmax);
    _flat_f[icut]->SetLineColor(kGreen);
    double acc(1.0);
    if(icut>0)acc = _conspec[icut]->Integral()/_conspec[0]->Integral();
    _flat_f[icut]->SetParameter(0,flat*mevperbin*acc);
  }

  _leg = new TLegend(0.7,0.8,0.9,0.9);
  _leg->AddEntry(_diospec[0],"DIO","L");
  _leg->AddEntry(_conspec[0],"Conversion","L");
  _leg->AddEntry(_flat_f[0],"RPC+AP+cosmic","L");

  _info = new TPaveText(0.4,0.8,0.7,0.9,"NDC");
  char text[80];
  snprintf(text,80,"%g stopped muons",nstopped);
  TString snstop(text);
  _info->AddText(snstop);
  snprintf(text,80,"%g Conversion Rate",conprob);
  TString sconprob(text);
  _info->AddText(sconprob);
  _info->SetBorderSize(0);
}

void mu2e::drawmu2e(double momlow, double momhigh,const char* suffix) {

  // plot results
  TCanvas* mu2ecan = new TCanvas("mu2e","mu2e result",900,600);
  mu2ecan->Clear();
  mu2ecan->Divide(1,1);
  TCanvas* allcan = new TCanvas("mu2eall","mu2e results",1200,800);
  allcan->Clear();
  allcan->Divide(2,2);
  for(unsigned icut=0;icut<4;icut++){
    allcan->cd(icut+1);
    gPad->SetLogy();
//    TH1* diocopy = _diospec[icut]->DrawCopy();
    _diospec[icut]->Draw();
    _conspec[icut]->Draw("same");
    _flat_f[icut]->Draw("same");

    int istart = _diospec[icut]->FindFixBin(momlow+0.5*mevperbin);
    int istop = _diospec[icut]->FindFixBin(momhigh-0.5*mevperbin);
    //    cout << "Integration low edge " << _diospec[icut]->GetBinLowEdge(istart) << " for cut at " << momlow << endl;
    //    cout << "Integration high edge " << _diospec[icut]->GetBinLowEdge(istop)+mevperbin << " for cut at " << momhigh << endl;
    double dint_err, cint_err;
    double dint = _diospec[icut]->IntegralAndError(istart,istop,dint_err);
    double cint = _conspec[icut]->IntegralAndError(istart,istop,cint_err);
    double fint = _flat_f[icut]->Integral(momlow,momhigh)/mevperbin;

    TPaveText* inttext = new TPaveText(0.5,0.6,0.9,0.8,"NDC");
    char itext[50];
    snprintf(itext,50,"%4.2f MeV/c < P < %4.2f MeV/c",momlow,momhigh);
    inttext->AddText(itext);
    snprintf(itext,50,"DIO integral = %4.2f #pm %4.2f",dint,dint_err);
    inttext->AddText(itext);
    snprintf(itext,50,"Conv. integral = %4.2f #pm %4.2f",cint,cint_err);
    inttext->AddText(itext);
    snprintf(itext,50,"RPC+AP+cosmic integral = %4.2f",fint);
    inttext->AddText(itext);
    inttext->Draw();

    TPaveText* cuttext = new TPaveText(0.1,0.5,0.4,0.8,"NDC");  
    char line[40];
    snprintf(line,80,"%4.3f<tan(#lambda)<%4.3f",tdlow,tdhigh);
    cuttext->AddText(line);
    snprintf(line,80,"t0>%5.1f nsec",t0min);
    cuttext->AddText(line);
    sprintf(line,"%s",ncuts[icut].GetTitle());
    cuttext->AddText(line);
    sprintf(line,"%s",t0cuts[icut].GetTitle());
    cuttext->AddText(line);
    sprintf(line,"%s",momcuts[icut].GetTitle());
    cuttext->AddText(line);
    sprintf(line,"%s",fitcuts[icut].GetTitle());
    cuttext->AddText(line);
    cuttext->Draw();

    TLine* momlowl = new TLine(momlow,0.0,momlow,1.5*_conspec[icut]->GetBinContent(_conspec[icut]->GetMaximumBin()));
    momlowl->SetLineColor(kBlack);
    momlowl->SetLineStyle(2);
    momlowl->SetLineWidth(2);
    momlowl->Draw();

    TLine* momhighl = new TLine(momhigh,0.0,momhigh,1.5*_conspec[icut]->GetBinContent(_conspec[icut]->GetMaximumBin()));
    momhighl->SetLineColor(kBlack);
    momhighl->SetLineStyle(2);
    momhighl->SetLineWidth(2);
    momhighl->Draw();
    _leg->Draw();
    _info->Draw();
    if(icut == mu2ecut){
      mu2ecan->cd(0);
      _diospec[icut]->Draw();
      _conspec[icut]->Draw("same");
      _flat_f[icut]->Draw("same");
      inttext->Draw();
      cuttext->Draw();
      momlowl->Draw();
      momhighl->Draw();
      _leg->Draw();
      _info->Draw();
    }
  }
  allcan->cd(0);
  std::string ssuf(suffix);
  allcan->SaveAs((std::string("mu2e_all")+ssuf).c_str());
  mu2ecan->SaveAs((std::string("mu2e")+ssuf).c_str());
}


void mu2e::drawdio(double momlow,double momhigh,const char* suffix) {
  std::string ssuf(suffix);
  TCanvas* dioc = new TCanvas("dioc","dio",1200,800);
  dioc->Divide(2,2);
  Double_t dmhi = trueconvmom;
  Double_t dmlow = trueconvmom - diogenrange;
  TH1F* diogen = new TH1F("diogen","True DIO momentum;MeV",_nbins,dmlow,dmhi);
  TH1F* diowt = new TH1F("diowt","True DIO momentum;MeV",_nbins,dmlow,dmhi);
  //  diowt->Sumw2();
  dio->Project("diogen","mcmom");
  dio->Project("diowt","mcmom","diowt");
  diowt->Scale(dioscale);
  diowt->SetLineColor(kBlue);
  diogen->SetLineColor(kRed);
  diowt->SetStats(0);
  diogen->SetStats(0);

  char ctext[80];
  snprintf(ctext,80,"fitmom>%f&&fitmom<%f",momlow,momhigh);
  TCut momwin(ctext);

  Int_t colors[4] = {kRed,kBlue,kGreen,kBlack};
  TH1F* diogenwin[4] = {0,0,0,0};
  TH1F* diodiffwin[4] = {0,0,0,0};
  const char* dopt[4] = {"","same","same","same"};
  const char* cutset[4] = {"Cutset A","Cutset B","Cutset C","Cutset D"};
  TLegend* dgenwinleg = new TLegend(.5,.6,.7,.9);
  for(unsigned icut=0;icut<4;icut++){
    char diogenname[50], diodiffname[50];
    snprintf(diogenname,50,"diogenwin%i",icut);
    diogenwin[icut] = new TH1F(diogenname,"True momentum of DIO in signal box;MeV",100,dmlow,dmhi);
    diogenwin[icut]->SetStats(0);

    snprintf(diodiffname,50,"diodiffwin%i",icut);
    diodiffwin[icut] = new TH1F(diodiffname,"Reco - true momentum of DIO in signal box;MeV",100,-1,2);
    diodiffwin[icut]->SetStats(0);

    dio->Project(diogenname,"mcentmom","diowt"*(final[icut]+momwin));
    diogenwin[icut]->SetFillColor(colors[icut]);
    dio->Project(diodiffname,"fitmom-mcentmom","diowt"*(final[icut]+momwin));
    diodiffwin[icut]->SetFillColor(colors[icut]);
    dgenwinleg->AddEntry(diogenwin[icut],cutset[icut],"f");
  }

  dioc->cd(1);
  gPad->SetLogy();
  // dead-reconing on spectrum, accounting for bins
  double diofscale = ndecay*diogenrange/_nbins;
  _diocz_f->SetParameter(0,diofscale);
  diowt->Draw();
  _diocz_f->Draw("same");
  diogen->Draw("same");
  TLegend* dioleg = new TLegend(.2,.4,.6,.6);
  dioleg->AddEntry(diogen,"Generated","l");
  dioleg->AddEntry(diowt,"Weighted","l");
  dioleg->AddEntry(_diocz_f,"Czarnecki etal","l");
  dioleg->Draw();

  dioc->cd(2);
  for(unsigned icut=0;icut<4;icut++){
    _diospec[icut]->SetFillColor(colors[icut]);
    if(icut==0)
      _diospec[icut]->Draw("Hist");
    else
      _diospec[icut]->Draw("Histsame");
  }
  dgenwinleg->Draw();
  TLine* momlowl = new TLine(momlow,0.0,momlow,1.5*_diospec[0]->GetBinContent(_diospec[0]->GetMaximumBin()));
  momlowl->SetLineColor(kBlack);
  momlowl->SetLineStyle(2);
  momlowl->SetLineWidth(2);
  momlowl->Draw();

  TLine* momhighl = new TLine(momhigh,0.0,momhigh,1.5*_diospec[0]->GetBinContent(_diospec[0]->GetMaximumBin()));
  momhighl->SetLineColor(kBlack);
  momhighl->SetLineStyle(2);
  momhighl->SetLineWidth(2);
  momhighl->Draw();

  dioc->cd(3);
  gPad->SetLogy();
  for(unsigned icut=0;icut<4;icut++){
    diogenwin[icut]->Draw(dopt[icut]);
  }
  dgenwinleg->Draw();

  dioc->cd(4);
  gPad->SetLogy();
  for(unsigned icut=0;icut<4;icut++){
    diodiffwin[icut]->Draw(dopt[icut]);
  }

  dioc->SaveAs((std::string("diocan")+ssuf).c_str());

  TCanvas* diores = new TCanvas("diores","DIO result",800,600);
  gPad->SetLogy();
  diodiffwin[mu2ecut]->Draw();
  double split = 0.35;
  TLine* td = new TLine(split,0.0,split,diodiffwin[mu2ecut]->GetMaximum());
  td->SetLineColor(kBlack);
  td->SetLineStyle(2);
  td->SetLineWidth(2);
  td->Draw();

  int istart = diodiffwin[mu2ecut]->FindFixBin(split);
  double core = diodiffwin[mu2ecut]->Integral(0,istart);
  double tail = diodiffwin[mu2ecut]->Integral(istart+1,100);
  double total = core+tail;
  core /= total;
  tail /= total;
  core *= 100;
  tail *= 100;
  cout <<"core = " << core << " tail = " << tail << endl;
  diores->SaveAs("diores.png");
  char ccore[30], ctail[30];
  snprintf(ccore,30,"%4.1f%%",core);
  snprintf(ctail,30,"%4.1f%%",tail);
  TText* tcore = new TText(0.2,0.4,ccore);
  TText* ttail = new TText(0.6,0.4,ctail);
  tcore->SetNDC();
  ttail->SetNDC();
  tcore->Draw();
  ttail->Draw();
}

void mu2e::Write(const char* savename) {
  TFile savefile(savename,"RECREATE");
  TH1F* diospec[4];
  TH1F* conspec[4];
  for(unsigned icut=0;icut<4;++icut){
    diospec[icut] = new TH1F(*_diospec[icut]);
    conspec[icut] = new TH1F(*_conspec[icut]);
  }
  TH1D* recodio = new TH1D(*_recodio);
  savefile.Write();
  savefile.Close();
}

void mu2e::Read(const char* savename) {
  TFile* savefile = new TFile(savename);
  for(unsigned icut=0;icut<4;++icut){
    char dioname[50];
    snprintf(dioname,50,"diospec%i",icut);
    char conname[50];
    snprintf(conname,50,"conspec%i",icut);
    char flatname[50];
    snprintf(flatname,50,"flat_f%i",icut);
    TH1F* diospec= dynamic_cast<TH1F*>(savefile->Get(dioname));
    TH1F* conspec = dynamic_cast<TH1F*>(savefile->Get(conname));
    if(diospec == 0 || conspec == 0){
      cout << "Can't find histograms" << endl;
      return;
    }
    _diospec[icut] = new TH1F(*diospec);
    _conspec[icut] = new TH1F(*conspec);

    if(icut==0){
      _nbins = _diospec[icut]->GetXaxis()->GetNbins();
      _mmin = _diospec[icut]->GetXaxis()->GetXmin();
      _mmax = _diospec[icut]->GetXaxis()->GetXmax();
      mevperbin = (_mmax-_mmin)/_nbins;
    }

    _flat_f[icut] = new TF1(flatname,"[0]",_mmin,_mmax);
    _flat_f[icut]->SetLineColor(kGreen);
    double acc(1.0);
    if(icut>0)acc = _conspec[icut]->Integral()/_conspec[0]->Integral();
    _flat_f[icut]->SetParameter(0,flat*mevperbin*acc);
  }

  _leg = new TLegend(0.7,0.8,0.9,0.9);
  _leg->AddEntry(_diospec[0],"DIO","L");
  _leg->AddEntry(_conspec[0],"Conversion","L");
  _leg->AddEntry(_flat_f[0],"RPC+AP+cosmic","L");

  _info = new TPaveText(0.4,0.8,0.7,0.9,"NDC");
  char text[80];
  snprintf(text,80,"%g stopped muons",nstopped);
  TString snstop(text);
  _info->AddText(snstop);
  snprintf(text,80,"%g Conversion Rate",conprob);
  TString sconprob(text);
  _info->AddText(sconprob);
  _info->SetBorderSize(0);
//  savefile.Close();
}

void mu2e::fitReco(unsigned icut) {
// fit the acceptance
  gStyle->SetOptFit(1);
  gStyle->SetOptStat(0);
  TH1F* amomd = new TH1F("amomd","DIO Acceptance vs Momentum;MeV/c",500,_mmin,_mmax);
  TH1F* amom = new TH1F("amom","DIO Acceptance vs Momentum;MeV/c",500,_mmin,_mmax);
  amom->Sumw2();
  amomd->Sumw2();
//  char fmomcut[80];
//  snprintf(fmomcut,80,"fitmom>%5.3f",mcmom);
  dio->Project("amom","mcmom",final[icut]+TCut("fitmom>mcmom-4.2"));
  dio->Project("amomd","mcmom");
  amom->Divide(amomd);
  _racc = new TF1("racc",recoacc,_mmin,_mmax,2);
  _racc->SetParName(0,"acc100");
  _racc->SetParName(1,"slope");

  _cball = new TF1("cball",crystalball,-10.0,5,7);
  _cball->SetParName(0,"Norm");
  _cball->SetParName(1,"x0");
  _cball->SetParName(2,"sigma");
  _cball->SetParName(3,"n");
  _cball->SetParName(4,"alpha");
  _cball->SetParName(5,"tailfrac");
  _cball->SetParName(6,"taillambda");
// set parameters according to cutset 'C'
  _cball->SetParameters(1.0,-0.8262,0.2416,3.551,0.3836,0.003,0.3259);
  TH1F* momres = new TH1F("momres","momentum resolution;MeV",_nbins,-7,3);
  con->Project("momres","fitmom-mcmom",final[icut]);
 
  TCanvas* fcan = new TCanvas("fcan","Fits",1000,800);
  fcan->Clear();
  fcan->Divide(2,1);
  fcan->cd(1);
  amom->Fit("racc");
  fcan->cd(2);
  gPad->SetLogy();
  double integral = momres->GetEntries()*momres->GetBinWidth(1);
  _cball->SetParameters(3*integral,momres->GetMean()+0.07,0.3*momres->GetRMS(),3.0,1.0,0.02,0.2);
  _cball->SetParLimits(5,0.001,0.4);
  _cball->SetParLimits(6,0.1,momres->GetRMS());
  momres->Fit("cball","LIR");
}

void mu2e::smearDIO(unsigned ntrials,unsigned nres) {
// raw dio spectrum
  TF1* diocz_f = new TF1("diocz_f",DIOCZ,95.0,trueconvmom,1);
  diocz_f->SetLineColor(kCyan);
  diocz_f->SetParameter(0,1.0);
  double buffer(4.0);
// resolution function
// override GRandom
  gRandom = new TRandom3(324913);
  TH1F* rawdio = new TH1F("rawdio","Raw DIO e^{-} Momentum;P_{true} (MeV/c);N #mu2e",_nbins,_mmin,_mmax);
  rawdio->Sumw2();
  _recodio = new TH1D("recodio","Reco Effects Applied DIO e^{-} Momentum;P_{reco} (MeV/c);N #mu2e",_nbins,_mmin,_mmax);
  _recodio->Sumw2();
  double genrange = trueconvmom-_mmin+buffer;
  for(unsigned itrial=0;itrial<ntrials;++itrial){
// make the range bigger than expected, to account for smearing
    double diomom = gRandom->Uniform(_mmin-buffer,trueconvmom);
    double diowt = diocz_f->Eval(diomom);
    double acc = _racc->Eval(diomom);
    double recowt = diowt*acc;
    rawdio->Fill(diomom,diowt);
    for(unsigned ires=0;ires<nres;++ires){
      double mres = _cball->GetRandom();
      double recomom = diomom+mres;
      _recodio->Fill(recomom,recowt); 
    }
  }
// scale these to the # of expected events for mu2e
  double rawscale = genrange*ndecay/ntrials;
  cout << "raw scale = " << rawscale << endl;
  rawdio->Scale(rawscale);
  double recoscale = rawscale/nres;
  cout << "reco scale = " << recoscale << endl;
  _recodio->Scale(recoscale);
  TCanvas* diocan = new TCanvas("diocan","dio spectra",800,600);
  diocan->Clear();
  diocan->Divide(2,1);
  diocan->cd(1);
  gPad->SetLogy();
  rawdio->SetMinimum(0.01);
  TF1* raw_f = new TF1("raw_f",DIOCZ,_mmin,_mmax,1);
  double rawscale_f = (_mmax-_mmin)*ndecay/_nbins;
  raw_f->SetParameter(0,rawscale_f);
  raw_f->SetLineColor(kBlack);
  double a5(8.6434e-17);
  double a6(1.16874e-17);
  double a7(-1.87828e-19);
  double a8(9.16327e-20);
  rawdio->SetMinimum(1e-3);
  rawdio->Draw();
  raw_f->Draw("same");
  diocan->cd(2);
  gPad->SetLogy();
  _recodio->SetMinimum(1e-3);
  _reco_f = new TF1("_reco_f",RECODIO,_mmin,trueconvmom,5);
  _reco_f->SetLineColor(kBlue);
  double recoscale_f  = genrange*ndecay*_racc->Eval(103.0)/_nbins;
  _reco_f->SetParameter(0,0.0);
  _reco_f->SetParameter(1,recoscale_f);
  _reco_f->SetParameter(2,a6/a5);
  _reco_f->SetParameter(3,a7/a5);
  _reco_f->SetParameter(4,a8/a5);
  _recodio->Fit("_reco_f","N");
  _recodio->Fit("_reco_f","MN");
  _recodio->Fit("_reco_f","M");

  TF1* dspeca_f = new TF1("dspeca_f",DIOCZ_R,_mmin,_mmax,4);
  dspeca_f->SetParameter(0,rawscale_f);
  dspeca_f->SetParameter(1,0.0);
  dspeca_f->SetParameter(2,_racc->GetParameter(0));
  dspeca_f->SetParameter(3,_racc->GetParameter(1));
  dspeca_f->SetLineColor(kCyan);

  TF1* dspece_f = new TF1("dspece_f",DIOCZ_R,_mmin,_mmax,4);
  dspece_f->SetParameter(0,rawscale_f);
  dspece_f->SetParameter(1,_cball->GetParameter(1)); // parameter 1 is the offset of the mean in the resolution function = average energy loss
  dspece_f->SetParameter(2,_racc->GetParameter(0));
  dspece_f->SetParameter(3,_racc->GetParameter(1));
  dspece_f->SetLineColor(kGreen);

  char ttitle[100];
  char rtitle[100];
  char title[100];
  double mevpb = (_mmax-_mmin)/_nbins;
  snprintf(ttitle,100,"DIO Momentum Spectrum;P_{TRUE} (MeV/c);N #mu2e/%2.2f MeV/c",mevpb);
  snprintf(rtitle,100,"DIO Momentum Spectrum;P_{RECO} (MeV/c);N #mu2e/%2.2f MeV/c",mevpb);
  snprintf(title,100,"DIO Momentum Spectrum;P (MeV/c);N #mu2e/%2.2f MeV/c",mevpb);
  TH1F* dspec = new TH1F("dspec",title,_nbins,_mmin,_mmax);
  TH1F* dspect = new TH1F("dspect",ttitle,_nbins,_mmin,_mmax);
  TH1F* dspeca = new TH1F("dspeca",ttitle,_nbins,_mmin,_mmax);
  TH1F* dspece = new TH1F("dspece",rtitle,_nbins,_mmin,_mmax);
  TH1F* dspecs = new TH1F("dspecs",rtitle,_nbins,_mmin,_mmax);
  dspec->SetMinimum(1e-3);
  dspec->SetMaximum(raw_f->Eval(_mmin)*10);
  dspect->SetMinimum(1e-3);
  dspect->SetMaximum(raw_f->Eval(_mmin)*5);
  dspeca->SetMinimum(1e-3);
  dspeca->SetMaximum(raw_f->Eval(_mmin)*5);
  dspece->SetMinimum(1e-3);
  dspece->SetMaximum(raw_f->Eval(_mmin)*5);
  dspecs->SetMinimum(1e-3);
  dspecs->SetMaximum(raw_f->Eval(_mmin)*5);
  TCanvas* diocan2 = new TCanvas("diocan2","DIO Spectrum Effects",1000,1000);
  diocan2->Divide(2,2);
  diocan2->cd(1);
  gPad->SetLogy();
  dspect->Draw();
  raw_f->Draw("same");
  TLegend* tleg = new TLegend(0.3,0.8,0.9,0.9);
  tleg->AddEntry(raw_f,"Czarnecki etal","L");
  tleg->Draw();
  diocan2->cd(2);
  gPad->SetLogy();
  dspeca->Draw();
  dspeca_f->Draw("same");
  TLegend* aleg = new TLegend(0.3,0.8,0.9,0.9);
  aleg->AddEntry(dspeca_f,"#times Acc_{Detector}","L");
  aleg->Draw();
  diocan2->cd(3);
  gPad->SetLogy();
  dspece->Draw();
  dspece_f->Draw("same");
  TLegend* eleg = new TLegend(0.3,0.8,0.9,0.9);
  eleg->AddEntry(dspece_f,"- #DeltaE_{Detector}","L");
  eleg->Draw();
  diocan2->cd(4);
  gPad->SetLogy();
  dspecs->Draw();
  _reco_f->Draw("same");
  TLegend* sleg = new TLegend(0.3,0.8,0.9,0.9);
  sleg->AddEntry(_reco_f,"#otimes #sigma_{Detector}","L");
  sleg->Draw();

  TCanvas* diocan3 = new TCanvas("diocan3","DIO Spectrum Effects",600,600);
  diocan3->Divide(1,1);
  diocan3->cd(1);
  gPad->SetLogy();
  dspec->Draw();
  raw_f->Draw("same");
  TLegend* leg = new TLegend(0.5,0.7,0.9,0.9);
  leg->AddEntry(raw_f,"Czarnecki etal","L");
  dspeca_f->Draw("same");
  leg->AddEntry(dspeca_f,"#times Acc_{Detector}","L");
  dspece_f->Draw("same");
  leg->AddEntry(dspece_f,"- #DeltaE_{Detector}","L");
  _reco_f->Draw("same");
  leg->AddEntry(_reco_f,"#otimes #sigma_{Detector}","L");
  leg->Draw();

}

void mu2e::doExperiments(double momlow, double momhigh,double cprob,unsigned ispec, unsigned nexp, unsigned npave) {
  unsigned ncans(0);
  if(npave > 0)
    ncans = ceil(float(nexp)/npave);
  std::vector<TCanvas*> cans(ncans,0);

// override GRandom
  gRandom = new TRandom3(nexp*nexp*7+13);

  double conmean = _conspec[ispec]->Integral()*cprob/conprob;
  double diomean = _diospec[ispec]->Integral();
  double flatmean = _flat_f[ispec]->Integral(_mmin,_mmax)/mevperbin;
  cout << "conv mean = " << conmean << " dio mean = " << diomean << " flat mean = " << flatmean << endl;

  int istart = _diospec[ispec]->FindFixBin(momlow+0.5*mevperbin);
  int istop = _diospec[ispec]->FindFixBin(momhigh-0.5*mevperbin);
  TLine* momlowl = new TLine(momlow,0.0,momlow,_diospec[ispec]->GetBinContent(_diospec[ispec]->GetMaximumBin()));
  momlowl->SetLineColor(kBlack);
  momlowl->SetLineStyle(2);
  momlowl->SetLineWidth(2);
  TLine* momhighl = new TLine(momhigh,0.0,momhigh,_diospec[ispec]->GetBinContent(_diospec[ispec]->GetMaximumBin()));
  momhighl->SetLineColor(kBlack);
  momhighl->SetLineStyle(2);
  momhighl->SetLineWidth(2);

  unsigned ican=0;
  unsigned ipave=1;
  char dioname[50];
  char conname[50];
  char flatname[50];
  TLegend* leg(0);
// fit each experiment DIO spectrum
  TF1* dioexp_f = new TF1("dioexp_f",RECOFITDIO,_mmin,trueconvmom,7);
  dioexp_f->SetLineColor(kBlue);
  for(unsigned ip=0;ip<5;++ip)
    dioexp_f->FixParameter(ip,_reco_f->GetParameter(ip));
  dioexp_f->SetParameter(5,0.0);
  dioexp_f->SetParameter(6,1.0);

  TH1F* ndio_h = new TH1F("ndio_h","N Events in Signal Window",15,-0.5,14.5);
  TH1F* nobk_h = new TH1F("nobk_h","N Events in Signal Window",15,-0.5,14.5);
  TH1F* ncon_h = new TH1F("ncon_h","N Events in Signal Window",15,-0.5,14.5);
  ndio_h->SetLineColor(kBlue);
  ncon_h->SetLineColor(kRed);
  nobk_h->SetLineColor(kGreen);
  TH1F* diofscale = new TH1F("diofscale","DIO Fit Scale",100,0.85,1.15);
  TH1F* diofshift = new TH1F("diofshift","DIO Fit Shift;#Delta P (MeV/c)",100,-0.15,0.15);
  TH2F* diofparams = new TH2F("diofparams","DIO Fit Parameters;Scale;Shift (MeV/c)",100,0.85,1.15,100,-0.15,0.15);
  TH1F* diofint = new TH1F("diofint","DIO Fit Signal Window Integral",100,0,0.4);
  TH1F* diofint_err = new TH1F("diofint_err","DIO Fit Signal Window Integral Error",100,0,0.08);
  TH2F* diofcomp = new TH2F("diofcomp","DIO Toy Comparison;N in Signal Window;Fit Integral in Signal Window",5,-0.5,4.5,100,0,0.4);

  for(unsigned iexp=0;iexp<nexp;++iexp){
    snprintf(conname,50,"conexp%i",iexp);
    TH1F* conexp_h = new TH1F(conname,"Sample Mu2e Experiment;Momentum (MeV/c);Events",_nbins,_mmin,_mmax);
    conexp_h->SetStats(0);
    conexp_h->SetLineColor(kRed);
    conexp_h->SetFillColor(kRed);
    conexp_h->SetMarkerStyle(2);
    conexp_h->SetMarkerColor(kRed);
    
    snprintf(dioname,50,"dioexp%i",iexp);
    TH1F* dioexp_h = new TH1F(dioname,"Sample Mu2e Experiment;Momentum (MeV/c);Events",_nbins,_mmin,_mmax);
    dioexp_h->SetStats(0);
    dioexp_h->SetLineColor(kBlue);
    dioexp_h->SetMarkerStyle(5);
    dioexp_h->SetMarkerColor(kBlue);

    snprintf(flatname,50,"flatexp%i",iexp);
    TH1F* flatexp_h = new TH1F(flatname,"Sample Mu2e Experiment;Momentum (MeV/c);Events",_nbins,_mmin,_mmax);
    flatexp_h->SetStats(0);
    flatexp_h->SetLineColor(kGreen);
    flatexp_h->SetMarkerStyle(7);
    flatexp_h->SetMarkerColor(kGreen);
    
    unsigned nconexp = gRandom->Poisson(conmean);
    unsigned ndioexp = gRandom->Poisson(diomean);
    unsigned nflatexp = gRandom->Poisson(flatmean);

    for(unsigned idio=0;idio<ndioexp;++idio){
      dioexp_h->Fill(_diospec[ispec]->GetRandom());
    }
    for(unsigned icon=0;icon<nconexp;++icon){
      conexp_h->Fill(_conspec[ispec]->GetRandom());
    }
    for(unsigned iflat=0;iflat<nflatexp;++iflat){
      flatexp_h->Fill(_flat_f[ispec]->GetRandom());
    }
    
    dioexp_h->Fit("dioexp_f","qL0","P");
    TF1* ff = dioexp_h->GetFunction("dioexp_f");
    if(ncans > 0){
      if(cans[ican]==0){
	char ctext[80];
	snprintf(ctext,80,"expcan%i",ican);
	cans[ican] = new TCanvas(ctext,"Simulated events",900,900);
	cans[ican]->Divide(npave,npave);
	ipave=1;
      }
      cans[ican]->cd(ipave);
      gPad->SetLogy();
      dioexp_h->Draw("H");
      ff->Draw("same");
      flatexp_h->Draw("sameHP");
      conexp_h->Draw("sameHP");
      momlowl->Draw();
      momhighl->Draw();
    } 

    double dint = dioexp_h->Integral(istart,istop);
    double cint = conexp_h->Integral(istart,istop);
    double fint = flatexp_h->Integral(istart,istop);

    double shift = ff->GetParameter(5);
    double scale = ff->GetParameter(6);
    double dfint = ff->Integral(momlow,momhigh)/mevperbin;
    double dfint_err = ff->IntegralError(momlow,momhigh)/mevperbin;
    ndio_h->Fill(dint);
    nobk_h->Fill(fint);
    ncon_h->Fill(cint);
    diofscale->Fill(scale);
    diofshift->Fill(shift);
    diofparams->Fill(scale,shift);
    diofint->Fill(dfint);
    diofint_err->Fill(dfint_err);
    diofcomp->Fill(dint,dfint);

    if(ncans > 0){

      cout << "DIO fit shift = " << shift << " scale = " << scale << " inetgral " << dfint << " +- " << dfint_err << endl;

      TPaveText* inttext = new TPaveText(0.5,0.5,0.9,0.9,"NDC");
      char text[80];
      snprintf(text,80,"%g stopped muons",nstopped);
      TString snstop(text);
      inttext->AddText(snstop);
      snprintf(text,80,"R_{#mu e} = %g",cprob);
      TString sconprob(text);
      inttext->AddText(sconprob);
      inttext->SetBorderSize(1);
      char itext[50];
      snprintf(itext,50,"%3.1f < P < %3.1f MeV/c",momlow,momhigh);
      inttext->AddText(itext);
      snprintf(itext,50,"N DIO = %2.0f",dint);
      inttext->AddText(itext);
      snprintf(itext,50,"N RPC+AP+Cosmic = %2.0f",fint);
      inttext->AddText(itext);
      snprintf(itext,50,"N Conversion = %2.0f",cint);
      inttext->AddText(itext);
      snprintf(itext,50,"DIO fit integral = %3.3f #pm %3.3f",dfint,dfint_err);
      inttext->AddText(itext);
      inttext->Draw();

      if(leg==0){
	leg = new TLegend(0.15,0.7,0.45,0.9);
	leg->AddEntry(dioexp_h,"DIO","L");
	leg->AddEntry(conexp_h,"Conversion","P");
	leg->AddEntry(flatexp_h,"RPC+AP+cosmic","P");
      }
      leg->Draw();
      ipave++;
      if(ipave>npave*npave)++ican;
    } else {
      delete conexp_h;
      delete dioexp_h;
      delete flatexp_h;
    }
  }
  TCanvas* expcan1 = new TCanvas("expcan1","Toy Experiments",800,800);
  expcan1->Clear();
  expcan1->Divide(2,2);
  expcan1->cd(2);
  nobk_h->Draw();
  ncon_h->Draw("same");
  ndio_h->Draw("same");

  TLegend* nleg = new TLegend(0.5,0.7,0.9,0.9);
  char title[80];
  snprintf(title,80,"Conversions, <N> = %3.3f",ncon_h->GetMean());
  nleg->AddEntry(ncon_h,title,"L");
  snprintf(title,80,"DIO, <N> = %3.3f",ndio_h->GetMean());
  nleg->AddEntry(ndio_h,title,"L");
  snprintf(title,80,"RPC, AP, + Cosmics, <N> = %3.3f",nobk_h->GetMean());
  nleg->AddEntry(nobk_h,title,"L");
  nleg->Draw();
  expcan1->cd(3);
  diofint->Draw();
  expcan1->cd(1);
  diofint_err->Draw();
  expcan1->cd(4);
  diofcomp->Draw();

  TCanvas* expcan2 = new TCanvas("expcan2","Toy Experiments",800,800);
  expcan2->Clear();
  expcan2->Divide(2,2);
  expcan2->cd(2);
  diofscale->Fit("gaus");
  expcan2->cd(3);
  diofshift->Fit("gaus");
  expcan2->cd(4);
  diofparams->Draw();

}
